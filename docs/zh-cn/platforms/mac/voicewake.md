---
summary: "mac 应用中的语音唤醒和按键通话模式及路由详情"
read_when:
  - 处理语音唤醒或 PTT 路径
title: "语音唤醒"
---

# 语音唤醒 & 按键通话

## 模式

- **唤醒词模式**（默认）：常驻语音识别器等待触发词（`swabbleTriggerWords`）。匹配时开始捕获，显示带有部分文本的浮层，并在静音后自动发送。
- **按键通话（按住右 Option 键）**：按住右 Option 键立即捕获——无需触发。按住时显示浮层；松开后在短暂延迟后最终确定并转发，以便你可以调整文本。

## 运行时行为（唤醒词）

- 语音识别器位于 `VoiceWakeRuntime`。
- 触发仅在唤醒词和下一个词之间有**有意义的停顿**时触发（约 0.55s 间隔）。浮层/提示音甚至可以在命令开始前的停顿时启动。
- 静音窗口：语音流动时 2.0s，如果只听到触发词则 5.0s。
- 硬停止：120s 防止会话失控。
- 会话间去抖：350ms。
- 浮层通过 `VoiceWakeOverlayController` 驱动，带有已提交/临时着色。
- 发送后，识别器干净重启以监听下一个触发。

## 生命周期不变量

- 如果启用了语音唤醒且权限已授予，唤醒词识别器应该在监听（除非正在进行显式的按键通话捕获）。
- 浮层可见性（包括通过 X 按钮手动关闭）绝不能阻止识别器恢复。

## 粘滞浮层故障模式（之前的问题）

以前，如果浮层卡住可见且你手动关闭它，语音唤醒可能看起来"死了"，因为运行时的重启尝试可能被浮层可见性阻止，且没有安排后续重启。

加固措施：

- 唤醒运行时重启不再被浮层可见性阻止。
- 浮层关闭完成通过 `VoiceSessionCoordinator` 触发 `VoiceWakeRuntime.refresh(...)`，因此手动 X 关闭总是恢复监听。

## 按键通话细节

- 热键检测使用全局 `.flagsChanged` 监视器检测**右 Option**（`keyCode 61` + `.option`）。我们只观察事件（不吞掉）。
- 捕获管道位于 `VoicePushToTalk`：立即启动语音，将部分内容流式传输到浮层，并在松开时调用 `VoiceWakeForwarder`。
- 按键通话开始时我们暂停唤醒词运行时以避免音频输入冲突；松开后自动重启。
- 权限：需要麦克风 + 语音识别；查看事件需要辅助功能/输入监控批准。
- 外部键盘：某些可能无法按预期暴露右 Option——如果用户报告问题，提供备用快捷键。

## 用户设置

- **语音唤醒**开关：启用唤醒词运行时。
- **按住 Cmd+Fn 说话**：启用按键通话监视器。在 macOS < 26 上禁用。
- 语言和麦克风选择器，实时电平表，触发词表，测试器（仅本地；不转发）。
- 麦克风选择器在设备断开时保留上次选择，显示断开提示，并临时回退到系统默认直到设备返回。
- **声音**：触发检测和发送时的提示音；默认为 macOS "Glass" 系统声音。你可以为每个事件选择任何 `NSSound` 可加载的文件（如 MP3/WAV/AIFF）或选择**无声音**。

## 转发行为

- 启用语音唤醒时，转录内容转发到活动网关/助手（与 mac 应用其他部分使用的相同本地/远程模式）。
- 回复发送到**上次使用的主提供商**（WhatsApp/Telegram/Discord/WebChat）。如果发送失败，错误会被记录，运行仍然可以通过 WebChat/会话日志查看。

## 转发负载

- `VoiceWakeForwarder.prefixedTranscript(_:)` 在发送前添加机器提示前缀。唤醒词和按键通话路径共享。

## 快速验证

- 打开按键通话，按住 Cmd+Fn，说话，松开：浮层应显示部分内容然后发送。
- 按住时，菜单栏耳朵应保持放大（使用 `triggerVoiceEars(ttl:nil)`）；松开后缩小。
