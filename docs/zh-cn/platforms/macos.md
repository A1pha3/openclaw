---
summary: "OpenClaw macOS 伴侣应用完整指南：菜单栏控制、网关管理、节点功能与系统集成"
read_when:
  - 在 macOS 上安装和配置 OpenClaw
  - 理解 macOS 应用的架构设计和运行机制
  - 掌握权限管理和安全配置
  - 排查网关连接和节点通信问题
title: "macOS 应用"
---

# OpenClaw macOS 伴侣应用完整指南

本指南全面介绍 OpenClaw 在 macOS 平台上的伴侣应用——一个集菜单栏控制、网关代理和节点功能于一体的原生应用程序。阅读本指南后，你将能够独立完成 macOS 平台的安装部署、权限配置、远程连接和故障排查，并理解其背后的设计原理和架构决策。

## 学习目标

完成本章节学习后，你将能够：

### 基础目标（必掌握）

- [ ] 理解 macOS 伴侣应用的**核心定位**和**功能边界**，明确它与网关、CLI 的关系
- [ ] 掌握**本地模式**与**远程模式**的适用场景、优缺点和切换方法
- [ ] 完成 **TCC 权限系统**的完整配置，理解每种权限的用途和安全影响
- [ ] 能够独立完成**入门流程**：安装应用 → 权限检查 → 网关连接验证

### 进阶目标（建议掌握）

- [ ] 深入理解 **Launchd 生命周期管理**，包括服务启停、重启和状态查询
- [ ] 掌握 **Exec 审批机制**的配置方法，能够设计符合安全策略的白名单规则
- [ ] 理解 **节点服务与应用的 IPC 通信架构**，能够诊断连接问题
- [ ] 能够配置和使用**深度链接**实现自动化触发

### 专家目标（挑战）

- [ ] 理解 macOS 应用如何暴露 **Canvas、相机、屏幕录制**等节点功能
- [ ] 能够设计**多网关场景**的远程连接方案，包括 SSH 隧道配置
- [ ] 能够为团队制定 macOS 平台的**安全基线**和**权限管理规范**
- [ ] 能够排查和解决**复杂的跨网络连接问题**

---

## 第一部分：核心概念与架构设计

### 为什么需要 macOS 伴侣应用

在理解具体用法之前，我们需要先理解**设计者为什么创造这个伴侣应用**。这不仅帮助你更好地使用这个工具，还能让你在遇到问题时做出更好的决策。

#### 设计背景与目标

OpenClaw 的核心是**网关（Gateway）**——一个运行在后台的 WebSocket 服务，负责管理会话、渠道连接、工具调用和事件处理。网关本身是**无状态的**、** headless 的**，它不直接与用户交互，也不具备访问 macOS 特有功能的能力。

**问题**：用户需要一个界面来查看状态、配置设置、授予权限；agent 需要访问 macOS 特有的能力（如系统命令执行、原生通知、屏幕录制、相机访问等）。

**解决方案**：macOS 伴侣应用承担三个核心角色：

| 角色 | 职责 | 技术实现 |
|------|------|----------|
| **菜单栏控制器** | 提供状态显示、快捷操作、设置界面 | SwiftUI 原生界面 |
| **权限管理者** | 管理 TCC 权限、处理安全策略 | TCC Framework |
| **节点宿主** | 暴露 macOS 特有功能给网关 | WebSocket + IPC |

#### 架构决策的权衡

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户体验层                              │
│            菜单栏图标 + 状态菜单 + 设置窗口（SwiftUI）            │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                       应用核心层                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐    │
│  │ 权限管理     │    │ 网关管理     │    │ 深度链接处理     │    │
│  │ TCC Prompt  │    │ launchd     │    │ URL Scheme      │    │
│  └─────────────┘    └─────────────┘    └─────────────────┘    │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                       节点功能层                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐   │
│  │ Canvas   │ │ Camera   │ │ Screen    │ │ system.run       │   │
│  │ 渲染引擎  │ │ 捕获     │ │ 录制      │ │ 命令执行         │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────────┘   │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                       通信协议层                                 │
│          WebSocket（节点连接） + IPC UDS（进程间通信）            │
└─────────────────────────────────────────────────────────────────┘
```

**设计权衡**：

- **为什么不把所有功能都放进网关？** macOS 的 TCC 权限系统要求应用程序必须由用户主动启动并授权。网关作为后台服务，无法获取通知、辅助功能、屏幕录制等敏感权限。伴侣应用作为用户启动的 GUI 应用，可以正常申请和使用这些权限。

- **为什么使用 WebSocket 而不是直接函数调用？** 远程模式需要在另一台机器上运行网关，此时 macOS 应用只能通过网络暴露本地功能。WebSocket 提供双向通信、持久连接和自动重连能力，是连接网关和控制节点的理想选择。

- **为什么不直接让网关调用系统命令？** `system.run` 涉及执行任意代码的极高风险。通过 Exec 审批机制，用户可以白名单特定命令，实现**最小权限原则**，避免 agent 滥用系统访问能力。

### 核心术语解析

| 术语 | 英文原文 | 说明 |
|------|----------|------|
| **网关** | Gateway | OpenClaw 的控制平面，WebSocket 服务（默认端口 18789） |
| **节点** | Node | 暴露特定平台能力的客户端，本例中即 macOS 伴侣应用 |
| **TCC** | Transparency, Consent, and Control | macOS 的隐私权限框架 |
| **Launchd** | launchd | macOS 的初始化进程管理系统 |
| **IPC** | Inter-Process Communication | 进程间通信，本应用使用 Unix Domain Socket |
| **UDS** | Unix Domain Socket | 同一台机器上的进程通信方式 |

---

## 第二部分：渐进式学习路径

### 阶段一：入门基础 ⭐

**目标**：完成最小化安装和基本功能验证

#### 1.1 安装与启动

**为什么先讲安装**：安装是所有后续操作的前提。macOS 应用有特殊的权限要求，安装顺序会影响权限授予流程。

**安装步骤**：

```
步骤 1：下载并安装 OpenClaw.app
├── 从官网或 GitHub Releases 下载
├── 拖动到 /Applications 文件夹
└── 首次启动时，系统会提示"无法验证开发者"

步骤 2：解决安装警告（如果出现）
├── 右键点击应用 → 打开
└── 或在终端执行：xattr -cr /Applications/OpenClaw.app
```

**认知负荷管理**：如果你是第一次使用 macOS 应用，可能会遇到"无法验证开发者"的警告。这是因为 OpenClaw 是开源软件，未通过 Apple 公证。这是正常现象，通过右键"打开"可以绕过。

#### 1.2 权限配置清单

**为什么需要权限**：macOS 的 TCC 框架要求应用明确获取用户授权才能访问敏感资源。没有这些权限，应用只能提供有限功能。

**权限检查清单**：

| 权限 | 用途 | 不授予的后果 |
|------|------|--------------|
| **通知权限** | 显示系统通知 | 无法接收 agent 的通知推送 |
| **辅助功能** | 控制其他应用、执行 AppleScript | 无法使用 system.run 的完整功能 |
| **屏幕录制** | 捕获屏幕内容、录制屏幕 | Canvas 截图、screen.record 失败 |
| **麦克风** | 语音唤醒、Talk Mode | 语音相关功能不可用 |
| **相机** | 拍照和录像 | camera.snap、camera.clip 失败 |
| **语音识别** | 语音命令识别 | 语音控制功能受限 |

**配置流程**：

```
1. 打开 OpenClaw 应用
2. 应用会自动检测缺失的权限
3. 点击"系统偏好设置"按钮逐一授权
4. 或手动访问：系统偏好设置 → 安全性与隐私 → 隐私
```

#### 1.3 验证网关运行

**为什么需要验证**：网关是整个系统的大脑。如果网关未运行，应用只能工作在有限模式下。

**验证命令**：

```bash
# 检查 launchd 服务状态
launchctl print gui/$UID/bot.molt.gateway

# 或使用应用内诊断
openclaw gateway status

# 查看网关日志
log show --predicate 'eventMessage CONTAINS "gateway"' --last 5m
```

**预期结果**：如果网关正常运行，你应该看到"active"状态，且应用菜单栏显示绿色连接图标。

---

### 阶段二：核心功能 ⭐⭐

**目标**：掌握本地模式和远程模式的配置，理解系统集成

#### 2.1 本地模式详解

**什么情况下使用本地模式**：当你主要在当前 Mac 上使用 OpenClaw，网关也在同一台机器上运行时。

**架构特点**：

```
┌────────────────────────────────────────────────────────────┐
│                        本地模式                            │
│                                                             │
│   ┌─────────────┐         ┌─────────────┐                 │
│   │ OpenClaw    │◄───────►│   Gateway   │                 │
│   │   App       │  WS     │  (本地)     │                 │
│   │ 菜单栏控制   │         │  :18789     │                 │
│   └─────────────┘         └─────────────┘                 │
│         │                         │                       │
│         ▼                         ▼                       │
│   ┌─────────────────────────────────────────────┐         │
│   │          共享进程空间（IPC UDS）             │         │
│   │    system.run 在 App 中执行                 │         │
│   │    TCC 上下文保持一致                        │         │
│   └─────────────────────────────────────────────┘         │
└────────────────────────────────────────────────────────────┘
```

**配置步骤**：

```bash
# 1. 安装并启动 launchd 服务
openclaw gateway install
openclaw gateway start

# 2. 确保应用设置为本地模式
# 应用 → 设置 → 连接模式 → 本地

# 3. 验证连接
openclaw gateway status
```

**优势与局限**：

| 优势 | 局限 |
|------|------|
| 延迟最低（同一机器通信） | 无法从其他设备访问 |
| 权限继承简单 | 网关与 App 命运绑定 |
| 配置简单 | 不适合远程办公场景 |

#### 2.2 远程模式详解

**什么情况下使用远程模式**：当你需要在另一台机器上运行网关，但仍想使用当前 Mac 的特有功能（如系统命令、通知、屏幕录制等）。

**架构特点**：

```
┌──────────────────────────┐      SSH 隧道       ┌──────────────────────────┐
│      远程机器            │◄──────────────────►│      本地 Mac            │
│   ┌─────────────┐       │                    │   ┌─────────────┐       │
│   │   Gateway   │       │                    │   │ OpenClaw    │       │
│   │  (远程)     │       │                    │   │   App       │       │
│   └─────────────┘       │                    │   │  (节点模式)  │       │
│         │                │                    │   └─────────────┘       │
│         ▼                │                    │         │               │
│   ┌─────────────┐       │                    │        │   │ 控制平面     │       │                    │   ┌──────────── ▼               │
─┐       │
│   │ WS :18789   │       │                    │   │ 节点宿主    │       │
│   └─────────────┘       │                    │   │ WS 连接到   │       │
│                          │                    │   │ 远程网关    │       │
└──────────────────────────┘                    │   └─────────────┘       │
                                                  │         │               │
                                                  │         ▼               │
                                                  │   ┌─────────────────┐   │
                                                  │   │ 本地功能暴露     │   │
                                                  │   │ system.run       │   │
                                                  │   │ 通知             │   │
                                                  │   │ Canvas/相机      │   │
                                                  └─────────────────────────┘
```

**配置步骤**：

```bash
# 1. 在远程机器上启动网关
ssh user@remote-host
openclaw gateway --port 18789

# 2. 在本地 Mac 上配置远程模式
# 应用 → 设置 → 连接模式 → 远程

# 3. 配置 SSH 隧道（应用自动处理或手动配置）
# 应用会自动建立 SSH 隧道连接远程网关

# 4. 验证节点连接
openclaw nodes status
```

**SSH 隧道配置详解**：

应用使用以下 SSH 参数建立隧道：

```
ssh -N -L 127.0.0.1:18789:127.0.0.1:18789 user@remote-host \
  -o BatchMode=yes \
  -o ExitOnForwardFailure=yes \
  -o ServerAliveInterval=60 \
  -o ServerAliveCountMax=3
```

| 参数 | 作用 | 专家解读 |
|------|------|----------|
| `-N` | 不执行远程命令 | 纯隧道模式，减少攻击面 |
| `-L` | 本地端口转发 | 远程网关看似在本地 |
| `BatchMode` | 禁用交互式输入 | 自动化友好 |
| `ExitOnForwardFailure` | 转发失败时退出 | 快速失败，快速恢复 |
| `ServerAlive` | 保持连接活跃 | 防止 NAT 超时 |

#### 2.3 模式对比与选择决策

**决策矩阵**：

| 场景 | 推荐模式 | 原因 |
|------|----------|------|
| 个人工作站，仅本地使用 | 本地模式 | 简单、低延迟 |
| 远程服务器运行网关 | 远程模式 | 功能完整分离 |
| 多 Mac 设备协同 | 远程模式 | 统一网关入口 |
| 开发调试 | 本地模式 | 易于排查问题 |
| 需要从外网访问 | 远程模式 + Tailscale | 安全穿透 |

---

### 阶段三：高级配置 ⭐⭐⭐

**目标**：掌握 Exec 审批机制、深度链接和系统集成

#### 3.1 Exec 审批机制

**为什么需要 Exec 审批**：`system.run` 允许 agent 执行任意 shell 命令。这是**最高风险**的功能——如果不受控制，agent 可能执行删除文件、泄露敏感信息等危险操作。

**设计原理**：Exec 审批机制采用**白名单模式**，默认拒绝所有命令，只有明确添加到白名单的命令才被允许执行。

**配置文件结构**：

```json
{
  "version": 1,
  "defaults": {
    "security": "deny",
    "ask": "on-miss"
  },
  "agents": {
    "main": {
      "security": "allowlist",
      "ask": "on-miss",
      "allowlist": [
        { "pattern": "/opt/homebrew/bin/rg" },
        { "pattern": "/usr/bin/git" },
        { "pattern": "/bin/ls" }
      ]
    }
  }
}
```

**配置字段详解**：

| 字段 | 可选值 | 说明 |
|------|--------|------|
| `defaults.security` | `deny` / `allowlist` | 默认安全策略 |
| `defaults.ask` | `on-miss` / `always` / `never` | 未匹配时的行为 |
| `agents.*.security` | `deny` / `allowlist` / `denylist` | 指定 agent 的策略 |
| `agents.*.allowlist` | glob 模式数组 | 允许执行的命令 |
| `agents.*.denylist` | glob 模式数组 | 明确禁止的命令 |

**安全等级设计**：

```markdown
### 安全等级 1：完全开放（不推荐）
{
  "defaults": { "security": "allowlist" },
  "agents": {
    "main": { "allowlist": [{ "pattern": "**/*" }] }
  }
}
```
> 风险：agent 可以执行任何命令，包括 `rm -rf /`

### 安全等级 2：白名单模式（推荐）
{
  "defaults": { "security": "deny" },
  "agents": {
    "main": {
      "security": "allowlist",
      "allowlist": [
        { "pattern": "/usr/bin/git" },
        { "pattern": "/usr/bin/ls" }
      ]
    }
  }
}
```
> 安全：仅允许明确指定的命令

### 安全等级 3：询问模式（开发环境）
{
  "defaults": { "security": "deny", "ask": "always" },
  "agents": {
    "main": { "security": "deny" }
  }
}
```
> 每次执行命令前都会询问用户
```

#### 3.2 深度链接

**什么是深度链接**：`openclaw://` URL scheme 允许外部应用或脚本触发 OpenClaw 的特定功能。

**使用场景**：

- 从 Alfred、Raycast 等启动器触发 agent
- 通过快捷指令（Shortcuts）自动化
- 从其他应用集成 OpenClaw

**深度链接格式**：

```
openclaw://agent?message=Hello&sessionKey=default&thinking=high
```

**参数详解**：

| 参数 | 必需 | 说明 |
|------|------|------|
| `message` | 是 | 要发送给 agent 的消息 |
| `sessionKey` | 否 | 会话密钥，默认为 `main` |
| `thinking` | 否 | 思考级别：off/minimal/low/medium/high/xhigh |
| `deliver` | 否 | 交付通道 |
| `to` | 否 | 目标收件人 |
| `channel` | 否 | 指定频道 |
| `timeoutSeconds` | 否 | 超时时间（秒） |
| `key` | 否 | 无人值守模式密钥 |

**安全机制**：

```
无 key → 应用弹出确认对话框
有有效 key → 直接执行，无人值守模式
```

#### 3.3 节点功能详解

**节点如何暴露功能**：macOS 应用将自己注册为网关的一个节点，通过 WebSocket 接收 `node.invoke` 命令并执行相应操作。

**可用命令类别**：

| 类别 | 命令 | 描述 |
|------|------|------|
| **Canvas** | `canvas.present` | 展示 Canvas 内容 |
| | `canvas.navigate` | 导航到指定 URL |
| | `canvas.eval` | 执行 JavaScript |
| | `canvas.snapshot` | 截图 |
| | `canvas.a2ui.*` | A2UI 相关操作 |
| **相机** | `camera.snap` | 拍摄照片 |
| | `camera.clip` | 录制视频片段 |
| **屏幕** | `screen.record` | 录制屏幕 |
| **系统** | `system.run` | 执行命令 |
| | `system.notify` | 发送通知 |

---

### 阶段四：专家技巧 ⭐⭐⭐⭐

**目标**：掌握底层调试、架构定制和问题诊断

#### 4.1 Launchd 深度管理

**为什么需要深入理解 Launchd**：Launchd 是 macOS 的核心进程管理器。理解它的工作原理可以帮助你诊断启动问题、管理服务生命周期、实现故障恢复。

**LaunchAgent 结构**：

```
标签：bot.molt.gateway（或 bot.molt.<profile>）
类型：User LaunchAgent（每用户）
位置：~/Library/LaunchAgents/bot.molt.gateway.plist
```

**管理命令**：

```bash
# 启动服务
launchctl bootstrap gui/$UID /path/to/agent.plist

# 停止服务
launchctl bootout gui/$UID/bot.molt.gateway

# 重启服务
launchctl kickstart -k gui/$UID/bot.molt.gateway

# 查看服务状态
launchctl print gui/$UID/bot.molt.gateway

# 禁用/启用服务
launchctl disable gui/$UID/bot.molt.gateway
launchctl enable gui/$UID/bot.molt.gateway
```

**调试技巧**：

```bash
# 查看详细日志
log stream --predicate 'eventMessage CONTAINS "openclaw"' --debug

# 查看系统日志
syslog -w | grep openclaw

# 检查配置文件
plutil -lint ~/Library/LaunchAgents/bot.molt.gateway.plist
```

#### 4.2 网关连接调试

**诊断工具**：macOS 应用提供了独立的调试 CLI，可以测试网关发现和连接逻辑，无需启动完整应用。

```bash
cd apps/macos

# 发现可用网关
swift run openclaw-mac discover --timeout 3000 --json

# 连接到指定网关
swift run openclaw-mac connect --url ws://127.0.0.1:18789 --json

# 带健康检查的探测
swift run openclaw-mac connect --probe --timeout 5000 --json
```

**连接选项详解**：

| 选项 | 说明 |
|------|------|
| `--url <ws://host:port>` | 覆盖自动发现，手动指定网关地址 |
| `--mode local\|remote` | 强制使用指定连接模式 |
| `--probe` | 强制进行新鲜健康检查 |
| `--timeout <ms>` | 请求超时时间 |
| `--json` | JSON 格式输出，便于脚本处理 |

**发现选项详解**：

| 选项 | 说明 |
|------|------|
| `--include-local` | 包含通常被过滤的"本地"网关 |
| `--timeout <ms>` | 发现窗口时间 |
| `--json` | JSON 格式输出 |

**对比分析**：应用使用 NWBrowser（Network.framework）进行本地发现，而 CLI 使用 `dns-sd` 命令。了解这个差异有助于排查发现不一致的问题。

#### 4.3 远程连接故障排查

**SSH 隧道是远程模式的核心**，理解其工作机制是排查问题的关键。

**隧道架构**：

```
┌─────────────────────────────────────────────────────────────────┐
│                         SSH 隧道                                │
│                                                                 │
│   本地应用                   SSH 连接                 远程网关   │
│   ┌────────┐            ┌──────────┐            ┌────────┐   │
│   │ App    │──127.0.0.1:│ SSH      │───网络────▶│ Gateway│   │
│   │        │   18789    │ Client   │            │ :18789 │   │
│   └────────┘            └──────────┘            └────────┘   │
│                              │                               │
│                              ▼                               │
│                        ┌─────────────────┐                  │
│                        │ SSH 服务器       │                  │
│                        │ 远程主机         │                  │
│                        └─────────────────┘                  │
└─────────────────────────────────────────────────────────────┘
```

**常见问题与解决方案**：

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 连接超时 | SSH 隧道未建立 | 检查 SSH 配置和密钥 |
| 网关看到 127.0.0.1 | SSH 隧道使用回环 | 使用 Direct WS/WSS 显示真实 IP |
| 频繁断开 | 网络不稳定 | 增加 ServerAlive 设置 |
| 权限拒绝 | SSH 密钥未授权 | 检查 `~/.ssh/authorized_keys` |

**IP 可见性问题**：SSH 隧道使用本地回环地址（127.0.0.1），因此网关看到的客户端 IP 始终是本地地址。如果需要显示真实客户端 IP，需要配置 Direct WebSocket 连接（使用 `ws://` 或 `wss://`）。

---

## 第三部分：专家思维模型

### 思维模型一：权限最小化原则

**核心思想**：只授予完成特定任务所需的最小权限集合。

**检查清单**：

```markdown
- [ ] 通知权限：是否真的需要推送通知？
- [ ] 辅助功能：是否需要控制其他应用？
- [ ] 屏幕录制：是否需要屏幕截图或录制？
- [ ] 麦克风：是否需要语音功能？
- [ ] 相机：是否需要拍照或录像？
```

**决策流程**：

```
需要功能 X？
├── 否 → 不授予权限 X
└── 是 →
    ├── 功能 X 是否可替代？
    │   ├── 是 → 使用替代方案，不授予权限 X
    │   └── 否 → 授予权限 X，但：
    │           ├── 定期审查使用情况
    │           └── 设置使用限制（如仅前台访问）
```

### 思维模型二：分层故障排查

**核心思想**：从下往上逐层排查，快速定位问题层级。

```
故障排查层级：

┌─────────────────────────────────────────┐
│  第 5 层：用户体验层                     │
│  症状：菜单栏图标显示异常、设置无法保存  │
│  排查：重启应用、清除缓存               │
├─────────────────────────────────────────┤
│  第 4 层：应用逻辑层                    │
│  症状：功能正常但行为异常               │
│  排查：查看应用日志、调试 IPC 通信       │
├─────────────────────────────────────────┤
│  第 3 层：节点功能层                    │
│  症状：特定命令失败                     │
│  排查：检查命令权限、TCC 状态           │
├─────────────────────────────────────────┤
│  第 2 层：通信协议层                    │
│  症状：无法连接网关                     │
│  排查：测试 WebSocket、SSH 隧道          │
├─────────────────────────────────────────┤
│  第 1 层：系统服务层                    │
│  症状：服务未启动、进程崩溃             │
│  排查：检查 launchd 状态、系统日志      │
└─────────────────────────────────────────┘
```

### 思维模型三：安全边界意识

**核心思想**：始终清楚什么在安全边界内、什么在边界外。

```
┌─────────────────────────────────────────────────────────────┐
│                       安全边界                              │
│                                                              │
│   边界内（受 Exec 审批保护）                                │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  system.run 执行的命令                              │   │
│   │  ├── 文件读写操作                                   │   │
│   │   ├── 网络请求                                      │   │
│   │   └── 系统配置修改                                  │   │
│   └─────────────────────────────────────────────────────┘   │
│                         ▲                                   │
│                         │ 审批机制                          │
│   边界外（不受 Exec 审批保护）                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  应用原生功能                                        │   │
│   │  ├── Canvas 渲染                                    │   │
│   │  ├── 相机捕获                                       │   │
│   │  ├── 通知推送                                       │   │
│   │  └── 节点命令执行                                   │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 第四部分：适用场景分析

### 场景一：个人生产力助手

**典型用户**：在个人 Mac 上工作的知识工作者

**推荐配置**：

```
模式：本地模式（默认）
├── 网关随用户登录自动启动（launchd）
├── 应用在菜单栏常驻
└── Exec 审批：白名单模式
    ├── 允许：git、ls、cat、grep 等基础命令
    └── 禁止：rm、chmod、chown 等危险命令
```

**工作流程**：

```
1. 用户通过菜单栏图标快速发送消息
2. Agent 通过 system.run 执行轻量任务
3. 结果通过通知或语音播报返回
```

### 场景二：远程开发环境

**典型用户**：开发者在笔记本上工作，网关运行在远程服务器

**推荐配置**：

```
模式：远程模式
├── 本地应用连接到远程网关
├── SSH 隧道保持连接
└── Exec 审批：严格白名单
    ├── 仅允许项目相关命令
    ├── 禁用危险命令
    └── 记录所有执行历史
```

**优势**：

- 统一开发环境（服务器与本地一致）
- 资源密集型任务在服务器执行
- 敏感操作留痕可审计

### 场景三：多设备协同

**典型用户**：拥有多台 Apple 设备的用户

**推荐配置**：

```
┌────────────────────────────────────────────────────────┐
│                      设备协同架构                       │
│                                                         │
│   Mac Studio（网关主机）                                 │
│   ┌─────────────┐                                       │
│   │   Gateway   │◄──────────┬──────────┐                │
│   │  :18789     │           │          │                │
│   └─────────────┘           │          │                │
│         │                   │          │                │
│         │ SSH/Tailscale     │          │                │
│         ▼                   ▼          ▼                │
│   ┌─────────────┐    ┌─────────────┐ ┌─────────────┐   │
│   │  MacBook   │    │   iPad      │ │  iPhone     │   │
│   │ (远程模式)  │    │   节点      │ │   节点      │   │
│   └─────────────┘    └─────────────┘ └─────────────┘   │
│                                                         │
└────────────────────────────────────────────────────────┘
```

**功能分配**：

| 设备 | 角色 | 暴露功能 |
|------|------|----------|
| Mac Studio | 网关主机 | 所有功能 |
| MacBook | 远程客户端 | system.run、通知 |
| iPad | 节点 | Canvas、相机、语音 |
| iPhone | 节点 | 相机、语音、定位 |

---

## 第五部分：故障排查指南

### 排查流程图

```
问题：应用/网关无法正常工作
│
├── 症状：菜单栏图标显示灰色
│   │
│   ├── 检查 1：网关是否运行？
│   │   └── launchctl print gui/$UID/bot.molt.gateway
│   │       │
│   │       ├── inactive → 启动服务
│   │       │   └── launchctl kickstart gui/$UID/bot.molt.gateway
│   │       └── not found → 安装服务
│   │           └── openclaw gateway install
│   │
│   └── 检查 2：应用是否连接？
│       └── 打开应用设置查看连接状态
│
├── 症状：权限相关错误
│   │
│   ├── 检查 1：TCC 权限是否授予？
│   │   └── 系统偏好设置 → 安全性与隐私 → 隐私
│   │
│   └── 检查 2：Exec 审批配置
│       └── ~/.openclaw/exec-approvals.json
│
├── 症状：远程连接失败
│   │
│   ├── 检查 1：SSH 隧道状态
│   │   └── launchctl print gui/$UID/ssh
│   │
│   └── 检查 2：网络连通性
│       └── ssh user@remote-host "echo test"
│
└── 症状：节点功能异常
    │
    ├── 检查 1：节点是否在线？
    │   └── openclaw nodes status
    │
    └── 检查 2：具体命令权限
        └── 查看应用日志
```

### 常见错误码与解决方案

| 错误码 | 含义 | 解决方案 |
|--------|------|----------|
| `PERMISSION_MISSING` | TCC 权限缺失 | 检查系统偏好设置中的权限授予状态 |
| `EXEC_DENIED` | Exec 审批拒绝 | 添加命令到白名单或调整策略 |
| `NODE_OFFLINE` | 节点离线 | 检查网络连接和应用状态 |
| `GATEWAY_UNREACHABLE` | 网关不可达 | 检查 launchd 服务和网络 |
| `IPC_ERROR` | IPC 通信失败 | 重启应用 |
| `TUNNEL_FAILED` | SSH 隧道建立失败 | 检查 SSH 配置和密钥 |

### 日志查看指南

```bash
# 应用日志
log stream --predicate 'eventMessage CONTAINS "OpenClaw"' --debug

# 网关日志
log stream --predicate 'eventMessage CONTAINS "gateway"' --last 5m

# 系统日志
syslog -w | grep -i openclaw

# 应用特定日志目录
ls -la ~/Library/Logs/OpenClaw/
```

---

## 第六部分：最佳实践总结

### 安全最佳实践

```markdown
### 1. Exec 审批白名单策略

**推荐配置**：
```json
{
  "version": 1,
  "defaults": {
    "security": "deny",
    "ask": "on-miss"
  },
  "agents": {
    "main": {
      "security": "allowlist",
      "ask": "on-miss",
      "allowlist": [
        { "pattern": "/usr/bin/git" },
        { "pattern": "/usr/bin/ls" },
        { "pattern": "/usr/bin/cat" },
        { "pattern": "/usr/bin/grep" },
        { "pattern": "/usr/bin/head" },
        { "pattern": "/usr/bin/tail" }
      ]
    }
  }
}
```

### 2. 定期审查权限

每月执行一次权限审查：
- 检查通知使用频率
- 审查 system.run 执行日志
- 清理未使用的白名单条目

### 3. 敏感操作二次确认

对于高风险操作，设置 Exec 审批为询问模式：
```json
{
  "agents": {
    "main": {
      "security": "allowlist",
      "ask": "always",
      "allowlist": [
        { "pattern": "/usr/bin/git" },
        { "pattern": "/usr/bin/docker" }
      ],
      "denylist": [
        { "pattern": "/usr/bin/sudo" },
        { "pattern": "/bin/rm" }
      ]
    }
  }
}
```
```

### 性能最佳实践

```markdown
### 1. 资源占用优化

- 限制后台运行功能
- 禁用不必要的节点功能
- 定期重启应用清理内存

### 2. 网络连接优化

- 使用有线网络减少延迟
- 配置合适的 SSH KeepAlive 间隔
- 使用 Tailscale 替代传统 VPN
```

### 可靠性最佳实践

```markdown
### 1. 故障恢复

配置 launchd 自动重启：
```xml
<!-- ~/Library/LaunchAgents/bot.molt.gateway.plist -->
<key>KeepAlive</key>
<dict>
    <key>SuccessfulExit</key>
    <false/>
</dict>
<key>RunAtLoad</key>
<true/>
```

### 2. 日志轮转

避免日志文件过大：
```bash
# 配置 logrotate
sudo nano /etc/logrotate.d/openclaw
```

### 3. 配置备份

定期备份关键配置：
```bash
# 备份 Exec 审批配置
cp ~/.openclaw/exec-approvals.json ~/.openclaw/backup/

# 备份网关配置
cp ~/.openclaw/openclaw.json ~/.openclaw/backup/
```
```

---

## 相关文档

- [网关操作手册](/zh-cn/gateway)
- [网关（macOS）](/zh-cn/platforms/mac/bundled-gateway)
- [macOS 权限](/zh-cn/platforms/mac/permissions)
- [Canvas](/zh-cn/platforms/mac/canvas)
- [远程网关访问](/zh-cn/gateway/remote)
- [节点功能参考](/zh-cn/nodes)
