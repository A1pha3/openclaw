---
summary: "详细介绍 OpenClaw 的系统架构，帮助深入理解各组件的职责和交互方式，涵盖网关、渠道、代理、会话、插件、数据流、网络模型、安全模型和配置系统"
read_when:
  - 首次了解 OpenClaw 架构时
  - 需要理解组件交互时
  - 排查架构相关问题时
title: "系统架构"
---

# 🏗️ 系统架构

**目标**：深入理解 OpenClaw 的整体架构设计，掌握各核心组件的职责、交互方式以及整体数据流。

本文档专为希望**从全局视角**理解 OpenClaw 的用户设计，包括系统管理员、开发者以及需要深入定制系统的进阶用户。

---

## 🎯 学习目标

完成本指南学习后，你将能够：

### 基础目标（必掌握）

- [ ] 理解 OpenClaw 的整体架构设计理念
- [ ] 掌握 Gateway、Channel、Agent、Session 四大核心组件
- [ ] 理解消息的入站和出站完整流程
- [ ] 理解本地模式和远程模式的区别

### 进阶目标（建议掌握）

- [ ] 理解安全模型和多层防护机制
- [ ] 掌握配置系统的优先级和热重载机制
- [ ] 理解水平扩展和高可用部署方案
- [ ] 能够根据场景选择最优部署方案

---

## 💡 为什么理解架构很重要？

### 设计决策背景

```
问题：为什么 OpenClaw 采用中心化网关架构？

挑战：
  - 多渠道管理复杂
  - AI 调用需要统一
  - 会话状态需要持久化
  - 安全和扩展性需要平衡

解决方案：中心化网关 + 分布式客户端

设计原则：
  ✅ 统一入口：所有消息通过 Gateway 处理
  ✅ 可扩展性：渠道、代理、工具都是插件化
  ✅ 安全性：分层认证和沙箱隔离
  ✅ 灵活性：支持本地和远程部署
```

### 架构演进

```
┌─────────────────────────────────────────────────────────────────┐
│                    OpenClaw 架构演进                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  v1.0：单体架构                                                 │
│    ├── 所有功能耦合在一起                                        │
│    ├── 难以维护和扩展                                           │
│    └── 单一入口点                                               │
│                                                                 │
│  v2.0：分离 Gateway 和 Agent                                   │
│    ├── Gateway：消息路由和控制平面                              │
│    ├── Agent：AI 处理和工具执行                                 │
│    └── 通过 RPC 通信                                            │
│                                                                 │
│  v3.0：完全插件化架构（当前版本）                              │
│    ├── Gateway：核心调度中心                                    │
│    ├── Channels：可插拔的消息渠道                              │
│    ├── Agents：可配置的 AI 代理                                │
│    ├── Plugins：插件系统                                         │
│    └── Tools：工具执行框架                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🏗️ 架构全景图

### 系统架构总览

```
┌─────────────────────────────────────────────────────────────────┐
│                      OpenClaw 系统架构                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    消息渠道层                            │  │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐            │  │
│   │  │ WhatsApp │ │ Telegram │ │ Discord  │            │  │
│   │  │   Baileys│ │ Bot API  │ │ discord.js│            │  │
│   │  └────┬─────┘ └────┬─────┘ └────┬─────┘            │  │
│   │       │            │            │                      │  │
│   │       └────────────┼────────────┘                      │  │
│   └────────────────────┼───────────────────────────────────┘  │
│                        ↓                                        │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    Gateway（网关层）                       │  │
│   │  ┌──────────────────────────────────────────────────┐ │  │
│   │  │              WebSocket Server                      │ │  │
│   │  │              ws://127.0.0.1:18789                 │ │  │
│   │  └──────────────────────────────────────────────────┘ │  │
│   │                                                         │  │
│   │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐  │  │
│   │  │  消息队列    │ │  路由引擎   │ │  会话管理   │  │  │
│   │  │ Message Queue │ │  Router     │ │  Session Mgr │  │  │
│   │  └──────────────┘ └──────────────┘ └──────────────┘  │  │
│   │                                                         │  │
│   └────────────────────┬────────────────────────────────────┘  │
│                        ↓                                        │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    Agent（代理层）                       │  │
│   │  ┌──────────────────────────────────────────────────┐ │  │
│   │  │              Pi Agent Runtime                     │ │  │
│   │  │              (RPC Mode)                           │ │  │
│   │  └──────────────────────────────────────────────────┘ │  │
│   │                                                         │  │
│   │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐  │  │
│   │  │  AI 模型调用 │ │  工具执行   │ │  上下文管理 │  │  │
│   │  │  Model Call  │ │  Tool Exec   │ │  Context Mgr │  │  │
│   │  └──────────────┘ └──────────────┘ └──────────────┘  │  │
│   └────────────────────┬────────────────────────────────────┘  │
│                        ↓                                        │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    外部服务                               │  │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │  │
│   │  │ Claude   │ │   GPT    │ │  Web APIs │ │ Databases│ │  │
│   │  │ Anthropic│ │  OpenAI  │ │  Services │ │  Storage │ │  │
│   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    客户端层                              │  │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │  │
│   │  │  CLI     │ │ Web UI  │ │ macOS App│ │  iOS/Android│ │
│   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔧 核心组件详解

### 1. Gateway（网关）

Gateway 是 OpenClaw 的**核心控制平面**，负责协调所有组件的通信。

#### Gateway 核心功能

```
┌─────────────────────────────────────────────────────────────────┐
│                    Gateway 核心功能                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  功能 1：消息路由                                               │
│  ├── 接收来自各渠道的消息                                        │
│  ├── 根据路由规则选择目标 Agent                                  │
│  └── 转发消息到正确的会话                                        │
│                                                                 │
│  功能 2：会话管理                                               │
│  ├── 创建和销毁会话                                             │
│  ├── 维护会话状态和上下文                                        │
│  └── 管理会话历史记录                                            │
│                                                                 │
│  功能 3：渠道连接                                              │
│  ├── 管理与各消息平台的连接                                      │
│  ├── 处理连接状态变化                                           │
│  └── 重连和错误恢复                                             │
│                                                                 │
│  功能 4：认证与安全                                             │
│  ├── 网关令牌验证                                               │
│  ├── 配对审批流程                                               │
│  └── 沙箱策略执行                                               │
│                                                                 │
│  功能 5：WebSocket 服务                                        │
│  ├── 提供实时通信接口                                           │
│  ├── 支持 RPC 调用                                              │
│  └── 处理事件订阅                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### Gateway 配置

```json5
{
  "gateway": {
    "port": 18789,           // 监听端口
    "bind": "loopback",     // 绑定地址（loopback/lan/tailnet）
    "auth": {
      "type": "token",      // 认证类型
      "token": "<generated>" // 自动生成的令牌
    }
  }
}
```

#### Gateway 启动

```bash
# 前台启动（查看日志）
openclaw gateway --port 18789 --verbose

# 后台运行
openclaw gateway --port 18789

# 查看状态
openclaw gateway status
```

### 2. Channel（消息渠道）

Channel 是 OpenClaw 与外部消息平台的**桥接层**，采用插件化设计。

#### 内置渠道

| 渠道 | 协议 | 特点 | 推荐度 |
|------|------|------|--------|
| **WhatsApp** | Baileys (Web) | 手机扫码登录，需要保持在线 | ⭐⭐⭐⭐ |
| **Telegram** | Bot API | Bot Token，最稳定 | ⭐⭐⭐⭐⭐ |
| **Discord** | Gateway + REST | 丰富的机器人功能 | ⭐⭐⭐⭐ |
| **Slack** | Socket Mode | 企业协作场景 | ⭐⭐⭐ |
| **iMessage** | imsg CLI | macOS 专用 | ⭐⭐⭐ |
| **Google Chat** | Webhook | 企业场景 | ⭐⭐⭐ |

#### 插件渠道

| 渠道 | 说明 | 类型 |
|------|------|------|
| **Mattermost** | 开源团队协作平台 | 插件 |
| **Matrix** | 去中心化通信协议 | 插件 |
| **Microsoft Teams** | 企业协作平台 | 插件 |
| **Signal** | 安全通信 | 插件 |
| **Line** | 亚洲流行通信应用 | 插件 |
| **Nostr** | 去中心化社交协议 | 插件 |
| **Twitch** | 直播平台聊天 | 插件 |
| **Zalo** | 越南流行通信应用 | 插件 |

#### Channel 架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Channel 架构原理                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                 Channel Adapter（渠道适配器）             │  │
│  │                                                         │  │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐  │  │
│  │  │  连接管理    │ │  消息收发   │ │  事件处理   │  │  │
│  │  │  Connection  │ │  Message IO  │ │  Event Proc │  │  │
│  │  └──────────────┘ └──────────────┘ └──────────────┘  │  │
│  └─────────────────────────────────────────────────────────┘  │
│                           ↓                                    │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │              Platform SDK（平台 SDK）                   │  │
│  │                                                         │  │
│  │  WhatsApp → Baileys      Telegram → Bot API            │  │
│  │  Discord → discord.js      Slack → Bolt                  │  │
│  └─────────────────────────────────────────────────────────┘  │
│                           ↓                                    │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │              Message Platform（消息平台）                 │  │
│  │                                                         │  │
│  │  WhatsApp      Telegram       Discord      Slack        │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3. Agent（AI 代理）

Agent 是实际**处理消息和调用 AI 模型**的组件。

#### Agent 工作流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    Agent 处理流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Step 1：消息接收                                               │
│     消息从 Gateway 到达 Agent                                   │
│         ↓                                                       │
│  Step 2：会话加载                                               │
│     加载对话历史和上下文                                        │
│         ↓                                                       │
│  Step 3：上下文准备                                             │
│     组装系统提示、用户消息、历史记录                             │
│         ↓                                                       │
│  Step 4：AI 模型调用                                            │
│     发送请求到 Claude/GPT 等                                    │
│         ↓                                                       │
│  Step 5：响应生成                                              │
│     AI 生成回复内容                                             │
│         ↓                                                       │
│  Step 6：工具执行（如有）                                        │
│     检测工具调用请求 → 执行工具 → 返回结果                      │
│         ↓                                                       │
│  Step 7：继续处理                                              │
│     工具结果合并到上下文，重复 Step 4                           │
│         ↓                                                       │
│  Step 8：回复发送                                              │
│     最终回复发送回 Gateway                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### Agent 配置

```json5
{
  "agents": {
    "defaults": {
      "model": "anthropic/claude-opus-4-5",
      "workspace": "~/.clawdbot/workspace",
      "sandbox": {
        "mode": "non-main"
      }
    },
    "list": [
      {
        "id": "main",
        "default": true,
        "identity": {
          "name": "OpenClaw",
          "emoji": "🦞"
        }
      }
    ]
  }
}
```

### 4. Session（会话）

Session 管理**对话的上下文和历史**，确保 AI 能够理解对话连贯性。

#### 会话类型

| 类型 | 会话键格式 | 说明 |
|------|------------|------|
| **DM** | `agent:main:whatsapp:dm:+15551234567` | 私聊会话 |
| **Group** | `agent:main:whatsapp:group:120363...@g.us` | 群聊会话 |
| **Channel** | `agent:main:discord:channel:1234567890` | 频道消息 |

#### 会话合并策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    会话合并策略                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  默认行为：                                                    │
│    同一用户的多个 DM 会话合并到 `main` 会话                      │
│                                                                 │
│  会话键格式：                                                   │
│    `{agent}:{channel}:{type}:{identifier}`                      │
│                                                                 │
│  示例：                                                         │
│    ├── main → agent:main:whatsapp:dm:+15551234567            │
│    ├── main → agent:main:telegram:dm:@username                │
│    └── main → agent:main:discord:dm:123456789                  │
│                                                                 │
│  优势：                                                        │
│    ├── 统一的对话历史                                           │
│    ├── 跨渠道的上下文共享                                       │
│    └── 简化管理                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 数据流详解

### 入站消息流

```
┌─────────────────────────────────────────────────────────────────┐
│                    入站消息完整流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  阶段 1：消息接收                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  消息平台 → 渠道适配器                                  │  │
│  │                                                       │  │
│  │  WhatsApp: 用户发送消息 → Baileys 接收               │  │
│  │  Telegram: Webhook/轮询 → Bot API 接收               │  │
│  │  Discord: Gateway Event → discord.js 接收             │  │
│  └───────────────────────────────────────────────────────┘  │
│                              ↓                                 │
│  阶段 2：消息转换                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  渠道适配器 → 统一消息格式                            │  │
│  │                                                       │  │
│  │  提取：                                                 │  │
│  │  ├── sender（发送者）                                 │  │
│  │  ├── content（内容）                                  │  │
│  │  ├── channel（渠道）                                  │  │
│  │  ├── timestamp（时间戳）                              │  │
│  │  ├── attachments（附件）                               │  │
│  │  └── metadata（元数据）                               │  │
│  └───────────────────────────────────────────────────────┘  │
│                              ↓                                 │
│  阶段 3：路由决策                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  路由引擎 → 选择目标 Agent                            │  │
│  │                                                       │  │
│  │  匹配顺序：                                            │  │
│  │  1. 精确匹配（特定聊天）                              │  │
│  │  2. 渠道匹配（按账号）                                │  │
│  │  3. 默认代理（main）                                  │  │
│  └───────────────────────────────────────────────────────┘  │
│                              ↓                                 │
│  阶段 4：会话处理                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  会话管理器 → 加载/创建会话                            │  │
│  │                                                       │  │
│  │  流程：                                                 │  │
│  │  ├── 查询会话是否存在                                 │  │
│  │  ├── 不存在 → 创建新会话                              │  │
│  │  └── 存在 → 加载历史记录                              │  │
│  └───────────────────────────────────────────────────────┘  │
│                              ↓                                 │
│  阶段 5：Agent 处理                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Agent Runtime → AI 处理                              │  │
│  │                                                       │  │
│  │  步骤：                                                 │  │
│  │  ├── 准备上下文                                       │  │
│  │  ├── 调用 AI 模型                                     │  │
│  │  ├── 执行工具（如有）                                  │  │
│  │  └── 生成回复                                         │  │
│  └───────────────────────────────────────────────────────┘  │
│                              ↓                                 │
│  阶段 6：回复发送                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Gateway → 渠道适配器 → 消息平台                       │  │
│  │                                                       │  │
│  │  状态跟踪：                                            │  │
│  │  ├── pending（发送中）                                │  │
│  │  ├── sent（已发送）                                   │  │
│  │  └── delivered（已送达）                              │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 出站消息流

```
┌─────────────────────────────────────────────────────────────────┐
│                    出站消息完整流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  来源 1：CLI 命令                                               │
│     openclaw message send --target +123456 --message "Hello"      │
│                              ↓                                    │
│  来源 2：Web 界面                                              │
│     通过 WebSocket 发送消息                                      │
│                              ↓                                    │
│  来源 3：自动化工具                                             │
│     Cron 任务、Webhook 触发                                      │
│                              ↓                                    │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Gateway RPC 接口                                      │  │
│  │                                                       │  │
│  │  认证验证 → 消息验证 → 路由选择 → 发送处理            │  │
│  └───────────────────────────────────────────────────────┘  │
│                              ↓                                    │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  渠道适配器 → 消息平台                                 │  │
│  │                                                       │  │
│  │  WhatsApp: Baileys 发送消息                          │  │
│  │  Telegram: Bot API sendMessage                        │  │
│  │  Discord: Channel.send()                              │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🌐 网络模型

### 本地模式（默认）

```
┌─────────────────────────────────────────────────────────────────┐
│                    本地模式网络配置                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Gateway:    ws://127.0.0.1:18789                              │
│  Canvas:     http://127.0.0.1:18793                            │
│                                                                 │
│  特点：                                                        │
│    ✅ 最高安全性（仅本地可访问）                               │
│    ✅ 最简单配置                                               │
│    ✅ 无需网络认证                                             │
│    ❌ 仅限本机使用                                             │
│                                                                 │
│  适用场景：                                                    │
│    ├── 个人开发测试                                            │
│    ├── 本地使用                                                │
│    └── 安全敏感环境                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 远程模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    远程模式网络配置                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Gateway:    wss://gateway.example.com:18789                   │
│  Canvas:     https://gateway.example.com:18793                  │
│                                                                 │
│  访问方式：                                                    │
│    ├── SSH 隧道：ssh -L 18789:localhost:18789 user@host       │
│    ├── Tailscale：使用 tailnet 地址                           │
│    └── 反向代理：Nginx/Caddy 配置 HTTPS                        │
│                                                                 │
│  安全考虑：                                                    │
│    ├── 必须启用令牌认证                                        │
│    ├── 建议使用 HTTPS/TLS                                     │
│    ├── 配置 IP 白名单                                          │
│    └── 监控访问日志                                            │
│                                                                 │
│  适用场景：                                                    │
│    ├── 多设备访问                                              │
│    ├── 服务器部署                                               │
│    └── 团队共享                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔐 安全模型

### 多层安全架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    安全防护层次                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Layer 1：网关认证                                              │
│  ├── Gateway Token（网关令牌）                                  │
│  │   ├── 自动生成（推荐）                                      │
│  │   └── 自定义令牌                                           │
│  └── 用途：验证所有 WebSocket 连接                              │
│                                                                 │
│  Layer 2：渠道认证                                              │
│  ├── WhatsApp：会话凭证                                         │
│  ├── Telegram：Bot Token                                        │
│  └── Discord：Bot Token                                        │
│                                                                 │
│  Layer 3：AI 认证                                              │
│  ├── Anthropic API Key / OAuth                                 │
│  ├── OpenAI API Key / OAuth                                    │
│  └── 其他提供商凭证                                             │
│                                                                 │
│  Layer 4：配对系统                                             │
│  ├── pairing（推荐）：未知用户需要审批                          │
│  ├── allowlist：仅白名单用户可访问                              │
│  ├── open：开放访问（高风险）                                   │
│  └── disabled：禁用私信                                         │
│                                                                 │
│  Layer 5：沙箱隔离                                              │
│  ├── sandbox: "off"：无隔离（开发环境）                       │
│  ├── sandbox: "non-main"：非主会话隔离（推荐）                │
│  └── sandbox: "all"：所有会话隔离（高安全）                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 沙箱隔离机制

```json5
{
  "agents": {
    "defaults": {
      "sandbox": {
        "mode": "non-main",        // 隔离模式
        "scope": "session",        // 隔离范围
        "workspaceAccess": "ro",   // 工作区访问权限
        "docker": {
          "image": "openclaw-sandbox:latest",
          "cpuLimit": "2",
          "memoryLimit": "2g",
          "network": "none"         // 禁用网络（可选）
        }
      }
    }
  }
}
```

---

## ⚙️ 配置系统

### 配置优先级

```
┌─────────────────────────────────────────────────────────────────┐
│                    配置优先级层次                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  优先级从高到低：                                                │
│                                                                 │
│  1. 命令行参数（最高）                                          │
│     └── --port、--config 等                                    │
│                                                                 │
│  2. 环境变量                                                   │
│     └── CLAWDBOT_CONFIG_PATH、ANTHROPIC_API_KEY 等             │
│                                                                 │
│  3. 用户配置文件                                               │
│     └── ~/.clawdbot/openclaw.json                              │
│                                                                 │
│  4. 默认配置（最低优先级）                                      │
│     └── 代码中的默认值                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 配置热重载

```
┌─────────────────────────────────────────────────────────────────┐
│                    配置热重载机制                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  监控机制：                                                     │
│    ├── 文件系统监控（inotify/fsevents）                        │
│    └── 自动检测配置文件变化                                      │
│                                                                 │
│  重载流程：                                                     │
│    ├── 检测配置文件变化                                          │
│    ├── 解析新配置                                              │
│    ├── 验证配置有效性                                          │
│    ├── 应用配置变更                                             │
│    └── 重启受影响组件                                           │
│                                                                 │
│  可热重载配置：                                                 │
│    ├── 渠道开关                                                 │
│    ├── 路由规则                                                 │
│    ├── 白名单                                                   │
│    └── 日志级别                                                 │
│                                                                 │
│  需重启网关配置：                                               │
│    ├── 端口绑定                                                 │
│    ├── 认证方式                                                 │
│    └── 沙箱模式                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🚀 扩展架构

### 水平扩展

```
┌─────────────────────────────────────────────────────────────────┐
│                    多实例部署架构                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐     ┌──────────────┐                       │
│  │  Gateway A   │     │  Gateway B   │                       │
│  │  (实例 1)    │     │  (实例 2)    │                       │
│  │  WhatsApp A  │     │  WhatsApp B  │                       │
│  │  端口 19001  │     │  端口 19002  │                       │
│  └──────┬───────┘     └──────┬───────┘                       │
│         │                    │                                 │
│         └────────┬──────────┘                                  │
│                  ↓                                             │
│         ┌────────┴────────┐                                    │
│         ↓                 ↓                                    │
│    ┌──────────┐     ┌──────────┐                              │
│    │ 共享存储 │     │ 负载均衡 │                              │
│    │  (NAS)   │     │  (nginx) │                              │
│    └──────────┘     └──────────┘                              │
│                                                                 │
│  注意事项：                                                     │
│    ├── 不同实例需要不同的渠道连接                               │
│    ├── 会话状态需要共享存储                                     │
│    └── 避免消息重复处理                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 高可用部署

```
┌─────────────────────────────────────────────────────────────────┐
│                    高可用架构                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                    ┌───────────────────┐                        │
│                    │    负载均衡器      │                        │
│                    │   (云 LB/nginx)   │                        │
│                    └─────────┬─────────┘                        │
│                              │                                 │
│              ┌───────────────┼───────────────┐                  │
│              ↓               ↓               ↓                  │
│        ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│        │ Gateway  │  │ Gateway  │  │ Gateway  │            │
│        │ Primary │  │ Secondary│  │ Standby  │            │
│        └────┬─────┘  └────┬─────┘  └────┬─────┘            │
│             │              │              │                    │
│             └──────────────┼──────────────┘                    │
│                            ↓                                    │
│              ┌───────────────────────────────┐                  │
│              │        共享存储/数据库         │                  │
│              │  ├── 会话状态                │                  │
│              │  ├── 配置同步                │                  │
│              │  └── 凭证存储（加密）        │                  │
│              └───────────────────────────────┘                  │
│                                                                 │
│  故障转移：                                                    │
│    ├── 健康检查（health check）                                │
│    ├── 自动故障检测                                            │
│    └── 无状态设计，支持快速切换                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 专家思维模型：架构决策框架

```
┌─────────────────────────────────────────────────────────────────┐
│                    部署决策流程                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  问题 1：部署规模？                                             │
│         ↓                                                       │
│     单用户 ←─┬─→ 多人使用                                       │
│         ↓                                                       │
│     本地模式                                                  │
│                                                                 │
│  问题 2：安全要求？                                            │
│         ↓                                                       │
│     高 ←─┬─→ 一般                                               │
│         ↓                                                       │
│     远程模式 + 令牌认证 + 沙箱                                  │
│                                                                 │
│  问题 3：可靠性要求？                                           │
│         ↓                                                       │
│     高可用 ←─┬─→ 基本可用                                       │
│         ↓                                                       │
│     多实例 + 共享存储                                           │
│                                                                 │
│  问题 4：维护复杂度？                                           │
│         ↓                                                       │
│     简单 ←─┬─→ 可接受                                           │
│         ↓                                                       │
│     官方镜像 + 自动化脚本                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📚 知识点回顾

完成本指南后，您应该掌握以下技能：

| 技能 | 掌握程度 |
|------|----------|
| 整体架构理解 | ⭐⭐⭐⭐⭐ |
| Gateway 功能 | ⭐⭐⭐⭐⭐ |
| Channel 管理 | ⭐⭐⭐⭐ |
| Agent 配置 | ⭐⭐⭐⭐ |
| Session 管理 | ⭐⭐⭐ |
| 安全模型 | ⭐⭐⭐⭐ |
| 部署方案 | ⭐⭐⭐ |

---

## 🎯 下一步学习

| 主题 | 文档链接 | 预计时间 |
|------|----------|----------|
| **Gateway 详解** | [Gateway 概念](/zh-CN/concepts/gateway) | 30 分钟 |
| **消息路由** | [路由机制](/zh-CN/concepts/routing) | 20 分钟 |
| **会话管理** | [会话系统](/zh-CN/concepts/sessions) | 25 分钟 |
| **安全配置** | [安全指南](/zh-CN/gateway/security) | 30 分钟 |
| **配置参考** | [完整配置](/zh-CN/config/reference) | 45 分钟 |

---

## 📖 附录

### 附录 A：端口说明

| 端口 | 服务 | 说明 |
|------|------|------|
| **18789** | Gateway | 主网关 WebSocket 端口 |
| **18793** | Canvas | Canvas 服务端口 |

### 附录 B：术语表

| 英文术语 | 中文术语 | 说明 |
|---------|---------|------|
| Gateway | 网关 | OpenClaw 核心控制平面 |
| Channel | 渠道 | 消息平台桥接层 |
| Agent | 代理 | AI 消息处理器 |
| Session | 会话 | 对话上下文管理 |
| Sandbox | 沙箱 | 安全隔离环境 |
| RPC | 远程过程调用 | 组件通信协议 |

### 附录 C：相关资源

- **官方文档**：[docs.openclaw.ai](https://docs.openclaw.ai)
- **GitHub**：[github.com/openclaw/openclaw](https://github.com/openclaw/openclaw)
- **架构讨论**：[GitHub Discussions](https://github.com/openclaw/openclaw/discussions)

---

> **💡 架构提示**：理解 OpenClaw 的架构对于高效使用和故障排查至关重要。建议先掌握整体架构，再深入学习各个组件的细节。

> *"好的架构不是设计出来的，而是在实践中演进出来的。"*
