---
summary: "网关调度器的 Cron 作业 + 唤醒 - 调度后台作业或唤醒代理"
read_when:
  - 调度后台作业或唤醒代理
  - 连接心跳和自动化的配合使用
  - 在心跳和 cron 之间为计划任务做出选择
title: "定时任务"
---

# 定时任务（网关调度器）

## 学习目标

完成本章节学习后，你将能够：

### 基础目标（必掌握）

- [ ] 理解 **Cron 作业** 的工作原理和设计理念
- [ ] 掌握三种计划类型的配置方法
- [ ] 理解主执行与隔离执行的差异
- [ ] 完成基础的定时任务配置

### 进阶目标（建议掌握）

- [ ] 配置复杂的任务路由和传递
- [ ] 优化任务调度性能
- [ ] 实现多代理任务管理

### 专家目标（挑战）

- [ ] 设计大规模任务调度系统
- [ ] 自定义调度策略
- [ ] 集成外部调度系统

---

## 为什么需要定时任务？

在理解具体用法之前，我们需要先理解**设计者为什么引入 Cron 作业系统**。这不仅帮助你更好地使用调度功能，还能让你在优化任务管理时做出更好的设计决策。

### 设计决策背景

**问题**：AI 助手需要支持定时触发的自动化任务，如定时提醒、周期性报告等

**可选方案**：

1. 方案 A - 外部 cron 服务：集成复杂，状态管理困难
2. 方案 B - 简单定时器：功能有限，难以管理
3. 方案 C（最终选择）- 内置调度器：与网关深度集成，状态持久化

**选择理由**：

- 理由一：任务持久化，重启不丢失
- 理由二：支持主执行和隔离执行两种模式
- 理由三：完善的传递机制支持多渠道输出

### 定时任务架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    定时任务系统架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                    作业管理层                          │  │
│  │                                                     │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐          │  │
│  │  │  添加   │  │  更新   │  │  删除   │          │  │
│  │  └─────────┘  └─────────┘  └─────────┘          │  │
│  └─────────────────────────┬───────────────────────────┘  │
│                            │                               │
│                            ▼                               │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                    调度引擎                          │  │
│  │                                                     │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌───────────┐ │  │
│  │  │ at（一次性） │  │every（间隔）│  │cron（周期）│ │  │
│  │  └──────┬──────┘  └──────┬──────┘  └─────┬─────┘ │  │
│  │         │                 │                │       │  │
│  │         └─────────────────┼────────────────┘       │  │
│  │                          │                        │  │
│  └──────────────────────────┼────────────────────────┘  │
│                             │                          │
│                             ▼                          │
│  ┌─────────────────────────────────────────────────────┐│
│  │                    执行引擎                           ││
│  │                                                     ││
│  │  ┌─────────────────────────────────────────────┐  ││
│  │  │               作业执行                       │  ││
│  │  │                                             │  ││
│  │  │  ┌─────────────────┐  ┌─────────────────┐│  ││
│  │  │  │  主执行模式      │  │  隔离执行模式    ││  ││
│  │  │  │                 │  │                 ││  ││
│  │  │  │ systemEvent    │  │ agentTurn      ││  ││
│  │  │  │ 心跳触发       │  │ 独立会话        ││  ││
│  │  │  └─────────────────┘  └─────────────────┘│  ││
│  │  └─────────────────────────────────────────┘  ││
│  └─────────────────────────┬───────────────────────────┘│
│                            │                             │
│                            ▼                             │
│  ┌─────────────────────────────────────────────────────┐│
│  │                    传递引擎                          ││
│  │                                                     ││
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐         ││
│  │  │  渠道   │  │  目标   │  │  格式   │         ││
│  │  │ 选择    │  │ 解析    │  │ 转换    │         ││
│  │  └─────────┘  └─────────┘  └─────────┘         ││
│  └─────────────────────────────────────────────────────┘│
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 核心概念速查

| 概念 | 定义 | 关键特性 |
|------|------|---------|
| **Cron 作业** | 网关内置的定时任务系统 | 持久化、调度、执行、传递 |
| **计划类型** | 任务执行的时间规则 | at、every、cron |
| **主执行** | 在主会话上下文中执行 | 共享上下文、心跳触发 |
| **隔离执行** | 在独立会话中执行 | 新上下文、独立执行 |
| **任务传递** | 将执行结果发送到渠道 | 渠道选择、目标解析 |

---

## 适用场景分析

### 场景一：定时提醒

**需求**：在指定时间发送提醒消息

**解决方案**：

```
定时触发 → 主执行 → 系统事件 → 用户收到提醒
```

**实际案例**：

- 会议提醒
- 服药提醒
- 生日祝福

### 场景二：周期性报告

**需求**：定期生成并发送报告

**解决方案**：

```
cron 触发 → 隔离执行 → AI 分析 → 渠道传递
```

**实际案例**：

- 每日摘要
- 周度报告
- 月度统计

### 场景三：自动化监控

**需求**：监控系统状态并触发动作

**解决方案**：

```
定时触发 → 执行检查 → 条件判断 → 动作执行
```

**实际案例**：

- 健康检查
- 异常告警
- 自动备份

---

## 专家思维模型：任务调度优化框架

当设计和管理定时任务时，专家会采用以下思维框架：

### 任务分类矩阵

| 任务类型 | 触发频率 | 执行模式 | 传递方式 | 示例 |
|---------|---------|---------|---------|------|
| 提醒类 | 低 | 主执行 | 直接发送 | 会议提醒 |
| 报告类 | 中 | 隔离执行 | 摘要发送 | 日报周报 |
| 监控类 | 高 | 隔离执行 | 条件触发 | 健康检查 |
| 同步类 | 中 | 隔离执行 | 结果返回 | 数据同步 |

### 决策流程

```
需要定时任务？
    │
    ├── 是 → 确定触发频率
    │           │
    │           ├── 一次性 → at
    │           ├── 间隔重复 → every
    │           └── 周期重复 → cron
    │
    └── 否 → 使用即时触发
```

---

## 学习路径规划

### 阶段一：基础概念（1-2 小时）

**目标**：建立定时任务的认知框架

1. 阅读本教程，理解系统架构
2. 创建第一个定时任务
3. 测试任务执行

### 阶段二：核心功能（2-4 小时）

**目标**：掌握实际使用中最常用的功能

4. 配置不同计划类型
5. 实现任务传递
6. 管理任务生命周期

### 阶段三：高级应用（4-8 小时）

**目标**：解决复杂场景和高级需求

7. 配置多代理任务
8. 优化调度性能
9. 实现复杂路由

### 阶段四：专家实战（8+ 小时）

**目标**：解决真实世界的复杂问题

10. 大规模任务调度
11. 自定义调度策略
12. 监控系统集成

---

## 渐进式复杂度：计划类型对比

### 计划类型功能矩阵

| 特性 | at | every | cron |
|-----|-----|-------|------|
| 一次性执行 | ✅ | ❌ | ❌ |
| 间隔重复 | ❌ | ✅ | ❌ |
| 周期重复 | ❌ | ❌ | ✅ |
| 时区支持 | ✅ | ✅ | ✅ |
| 复杂调度 | ❌ | ❌ | ✅ |

### 复杂度等级说明

| 等级 | 描述 | 示例任务 |
|-----|------|---------|
| **Level 1 ⭐** | 基础一次性任务 | at 提醒 |
| **Level 2 ⭐⭐** | 简单重复任务 | every 间隔任务 |
| **Level 3 ⭐⭐⭐** | 周期调度任务 | cron 定时任务 |
| **Level 4 ⭐⭐⭐⭐** | 复杂调度系统 | 多代理多渠道任务 |

---

## 故障排查实战

### 场景一：任务不执行

**问题描述**：设置的任务没有按时执行

**排查步骤**：

1. **检查 Cron 是否启用**

   ```bash
   openclaw config get cron.enabled
   ```

2. **检查网关状态**

   ```bash
   openclaw gateway status
   ```

3. **检查任务列表**

   ```bash
   openclaw cron list
   ```

4. **检查时区设置**

   ```bash
   # 确认时区配置正确
   date
   ```

**解决方案**：

- 启用 Cron 功能
- 确保网关运行
- 检查任务配置

### 场景二：传递失败

**问题描述**：任务执行但未发送到指定渠道

**排查步骤**：

1. **检查传递配置**

   ```bash
   openclaw cron describe <job-id>
   ```

2. **检查渠道状态**

   ```bash
   openclaw channels status
   ```

3. **查看任务日志**

   ```bash
   openclaw cron runs --id <job-id>
   ```

**解决方案**：

- 修复传递配置
- 确保渠道可用
- 检查目标格式

### 场景三：权限错误

**问题描述**：任务执行时返回权限错误

**排查步骤**：

1. **检查代理权限**

   ```bash
   openclaw config get agents.list[0].tools
   ```

2. **检查渠道权限**

   ```bash
   openclaw config get channels
   ```

**解决方案**：

- 授予必要权限
- 限制任务范围
- 使用隔离执行

---

## 最佳实践

### 实践一：提醒任务配置

**目标**：创建可靠的提醒任务

```json5
{
  name: "会议提醒",
  schedule: {
    kind: "at",
    atMs: 1704067200000  // 2024-01-01 00:00:00 UTC
  },
  sessionTarget: "main",
  wakeMode: "now",
  payload: {
    kind: "systemEvent",
    text: "提醒：今天的会议将在 10:00 开始"
  },
  deleteAfterRun: true
}
```

**最佳实践要点**：

- 设置 deleteAfterRun 避免一次性任务堆积
- 使用 wakeMode 控制唤醒时机
- 设置合理的提醒时间

### 实践二：报告任务配置

**目标**：创建自动化的周期性报告

```json5
{
  name: "每日摘要",
  schedule: {
    kind: "cron",
    expr: "0 8 * * *",
    tz: "Asia/Shanghai"
  },
  sessionTarget: "isolated",
  wakeMode: "next-heartbeat",
  payload: {
    kind: "agentTurn",
    message: "请总结今天的重要事项并生成日报。",
    deliver: true,
    channel: "whatsapp",
    to: "+15551234567",
    bestEffortDeliver: true
  },
  isolation: {
    postToMainPrefix: "Cron",
    postToMainMode: "summary"
  }
}
```

**最佳实践要点**：

- 使用隔离执行避免干扰主会话
- 配置 bestEffortDeliver 避免传递失败导致任务失败
- 设置合适的 postToMainMode

### 实践三：多代理任务配置

**目标**：在特定代理下执行任务

```json5
{
  name: "代码审查",
  schedule: {
    kind: "cron",
    expr: "0 10 * * *",
    tz: "Asia/Shanghai"
  },
  sessionTarget: "isolated",
  agentId: "coder",
  payload: {
    kind: "agentTurn",
    message: "请检查昨天的代码变更并提供审查意见。"
  }
}
```

**最佳实践要点**：

- 使用 agentId 绑定特定代理
- 代理不可用时回退到默认代理
- 考虑代理的可用性和负载

---

## CLI 命令参考

### 任务管理命令

| 命令 | 说明 |
|------|------|
| `openclaw cron add` | 添加新任务 |
| `openclaw cron list` | 列出所有任务 |
| `openclaw cron edit` | 编辑任务 |
| `openclaw cron remove` | 删除任务 |
| `openclaw cron run` | 手动运行任务 |
| `openclaw cron runs` | 查看任务运行历史 |

### 参数说明

| 命令 | 参数 | 说明 |
|-----|------|------|
| `cron add` | `--name` | 任务名称 |
| `cron add` | `--at` | 一次性时间 |
| `cron add` | `--cron` | Cron 表达式 |
| `cron add` | `--every` | 间隔时间 |
| `cron add` | `--session` | 执行模式 |
| `cron add` | `--message` | 任务消息 |
| `cron add` | `--deliver` | 启用传递 |
| `cron add` | `--agent` | 绑定代理 |

### 使用示例

```bash
# 添加一次性提醒
openclaw cron add \
  --name "Reminder" \
  --at "2026-02-01T16:00:00Z" \
  --session main \
  --system-event "Reminder: check the cron docs draft" \
  --wake now \
  --delete-after-run

# 添加周期性任务
openclaw cron add \
  --name "Morning brief" \
  --cron "0 7 * * *" \
  --tz "America/Los_Angeles" \
  --session isolated \
  --message "Summarize overnight updates." \
  --deliver \
  --channel slack \
  --to "channel:C1234567890"

# 手动运行任务
openclaw cron run <job-id> --force

# 查看运行历史
openclaw cron runs --id <job-id> --limit 50
```

---

## 原理解析：执行模式详解

### 主执行模式

在主会话上下文中执行任务：

```
任务触发
    │
    ▼
┌─────────────────────┐
│  系统事件入队        │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  下次心跳处理        │  ← wakeMode: next-heartbeat
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  主会话执行          │  ← 共享上下文
└─────────────────────┘
```

### 隔离执行模式

在独立会话中执行任务：

```
任务触发
    │
    ▼
┌─────────────────────┐
│  创建独立会话        │  ← cron:<jobId>
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  独立代理回合        │  ← 新上下文，无历史
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  结果处理            │
│                     │
│  ┌────────────────┐│
│  │ 发布到主会话    ││  ← postToMain
│  └────────────────┘│
│                     │
│  ┌────────────────┐│
│  │ 渠道传递        ││  ← deliver
│  └────────────────┘│
└─────────────────────┘
```

---

## 总结

定时任务是 OpenClaw 实现自动化管理的核心功能。通过完善的任务调度系统，你可以：

- 创建一次性或周期性的自动化任务
- 在主会话或隔离会话中执行
- 将结果传递到指定渠道
- 实现复杂的任务编排

掌握定时任务的配置和使用，将帮助你更好地管理和自动化工作流程。

---

## 进阶学习路径

| 级别 | 主题 | 资源 |
|-----|------|-----|
| ⭐ | 基础任务配置 | [快速开始](/zh-CN/start/quick-start) |
| ⭐⭐ | 高级调度配置 | [Webhook 自动化](/zh-CN/automation/webhook) |
| ⭐⭐⭐ | 复杂任务编排 | [自动化指南](/zh-CN/automation) |
| ⭐⭐⭐⭐ | 企业级调度 | [运维指南](/zh-CN/operators) |

---

## 相关文档

- [Webhook 自动化](/zh-CN/automation/webhook) - Webhook 触发
- [自动化概述](/zh-CN/automation) - 自动化指南
- [CLI 参考](/zh-CN/cli) - 命令行工具
- [配置参考](/zh-CN/config/reference) - 完整配置选项

---

**定时任务让 OpenClaw 自动化管理更加智能！** 🦞