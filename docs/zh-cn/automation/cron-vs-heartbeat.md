---
summary: "关于在自动化中选择心跳还是 cron 任务的指导"
read_when:
  - "决定如何调度定期任务"
  - "设置后台监控或通知"
  - "优化定期检查的 token 使用量"
title: "Cron 与心跳对比"
---

# Cron 与心跳：何时使用哪种方式

心跳和 cron 任务都可以让你按计划运行任务。本指南帮助你为你的使用场景选择正确的机制。

## 快速决策指南

| 使用场景                           | 推荐方案              | 原因                                            |
| ---------------------------------- | --------------------- | ----------------------------------------------- |
| 每 30 分钟检查一次收件箱           | 心跳                  | 与其他检查批量处理，上下文感知                  |
| 每天早上 9 点准时发送报告          | Cron（独立）          | 需要精确时间                                    |
| 监控日历以获取即将到来的事件       | 心跳                  | 适合周期性感知                                  |
| 运行每周深度分析                   | Cron（独立）          | 独立任务，可以使用不同的模型                    |
| 20 分钟后提醒我                    | Cron（主会话，`--at`） | 一次性精确计时提醒                              |
| 后台项目健康检查                   | 心跳                  | 利用现有周期                                    |

## 心跳：周期性感知

心跳在**主会话**中以固定间隔运行（默认：30 分钟）。它们设计用于代理检查各项事务并呈现任何重要内容。

### 何时使用心跳

- **多个定期检查**：与其设置 5 个独立的 cron 任务分别检查收件箱、日历、天气、通知和项目状态，不如用一个心跳批量处理所有这些。
- **上下文感知决策**：代理拥有完整的主会话上下文，因此可以智能地决定什么是紧急的，什么可以等待。
- **对话连续性**：心跳运行共享同一个会话，所以代理会记住最近的对话，可以自然地进行后续跟进。
- **低开销监控**：一个心跳取代了许多小型轮询任务。

### 心跳优势

- **批量多个检查**：一个代理回合可以同时收件箱、日历和通知。
- **减少 API 调用**：一个心跳比 5 个独立的 cron 任务更便宜。
- **上下文感知**：代理知道你在做什么工作，可以相应地优先处理。
- **智能抑制**：如果不需要关注的事项，代理回复 `HEARTBEAT_OK`，不会发送任何消息。
- **自然计时**：根据队列负载会有轻微偏移，这对大多数监控来说没问题。

### 心跳示例：HEARTBEAT.md 检查清单

```md
# 心跳检查清单

- 检查收件箱中是否有紧急消息
- 审查接下来 2 小时内的日历事件
- 如果后台任务完成，汇总结果
- 如果空闲 8 小时以上，发送简短的问候
```

代理在每次心跳时读取这个文件，在一个回合中处理所有项目。

### 配置心跳

```json5
{
  agents: {
    defaults: {
      heartbeat: {
        every: "30m", // 间隔
        target: "last", // 发送提醒的位置
        activeHours: { start: "08:00", end: "22:00" }, // 可选
      },
    },
  },
}
```

有关完整配置，请参阅[心跳](/gateway/heartbeat)。

## Cron：精确调度

Cron 任务在**精确时间**运行，可以在不影响主上下文的情况下在独立会话中运行。

### 何时使用 cron

- **需要精确计时**："每周一 9:00 发送这个"（不是"大约 9 点"）。
- **独立任务**：不需要对话上下文的任务。
- **不同模型/思考**：需要更强大模型的深度分析。
- **一次性提醒**："20 分钟后提醒我"，使用 `--at`。
- **频繁/嘈杂的任务**：会扰乱主会话历史记录的任务。
- **外部触发器**：应该独立于代理是否活跃而运行的任务。

### Cron 优势

- **精确计时**：带时区支持的 5 字段 cron 表达式。
- **会话隔离**：在 `cron:<jobId>` 中运行，不会污染主历史记录。
- **模型覆盖**：每个任务可以使用更便宜或更强大的模型。
- **发送控制**：可以直接发送到通道；默认仍会向主会话发布摘要（可配置）。
- **无需代理上下文**：即使主会话空闲或压缩也会运行。
- **一次性支持**：`--at` 用于精确的未来时间戳。

### Cron 示例：每日早间简报

```bash
openclaw cron add \
  --name "Morning briefing" \
  --cron "0 7 * * *" \
  --tz "America/New_York" \
  --session isolated \
  --message "Generate today's briefing: weather, calendar, top emails, news summary." \
  --model opus \
  --deliver \
  --channel whatsapp \
  --to "+15551234567"
```

这在纽约时间精确 7:00 运行，使用 Opus 以保证质量，并直接发送到 WhatsApp。

### Cron 示例：一次性提醒

```bash
openclaw cron add \
  --name "Meeting reminder" \
  --at "20m" \
  --session main \
  --system-event "Reminder: standup meeting starts in 10 minutes." \
  --wake now \
  --delete-after-run
```

有关完整的 CLI 参考，请参阅 [Cron 任务](/automation/cron-jobs)。

## 决策流程图

```
任务是否需要在精确时间运行？
  是 -> 使用 cron
  否 -> 继续...

任务是否需要与主会话隔离？
  是 -> 使用 cron（独立）
  否 -> 继续...

这个任务可以与其他定期检查批量处理吗？
  是 -> 使用心跳（添加到 HEARTBEAT.md）
  否 -> 使用 cron

这是一次性提醒吗？
  是 -> 使用带有 --at 的 cron
  否 -> 继续...

它需要不同的模型或思考级别吗？
  是 -> 使用带有 --model/--thinking 的 cron（独立）
  否 -> 使用心跳
```

## 组合使用

最高效的设置**同时使用两者**：

1. **心跳**处理常规监控（收件箱、日历、通知），每 30 分钟在一个批量回合中完成。
2. **Cron**处理精确计划（每日报告、每周回顾）和一次性提醒。

### 示例：高效的自动化设置

**HEARTBEAT.md**（每 30 分钟检查）：

```md
# 心跳检查清单

- 扫描收件箱中的紧急邮件
- 检查接下来 2 小时的日历事件
- 审查任何待处理的任务
- 如果安静 8 小时以上，轻微问候
```

**Cron 任务**（精确计时）：

```bash
# 每天早上 7 点的早间简报
openclaw cron add --name "Morning brief" --cron "0 7 * * *" --session isolated --message "..." --deliver

# 每周一早上 9 点的项目回顾
openclaw cron add --name "Weekly review" --cron "0 9 * * 1" --session isolated --message "..." --model opus

# 一次性提醒
openclaw cron add --name "Call back" --at "2h" --session main --system-event "Call back the client" --wake now
```

## Lobster：带审批的确定性工作流

Lobster 是**多步骤工具流水线**的工作流运行时，需要确定性执行和显式审批。
当任务不仅仅是单个代理回合，并且你希望拥有可恢复的工作流和人工检查点时使用它。

### Lobster 适合的场景

- **多步骤自动化**：你需要固定的工具调用流水线，而不是一次性的提示。
- **审批门**：副作用应该暂停直到你批准，然后恢复。
- **可恢复运行**：恢复暂停的工作流，无需重新运行前面的步骤。

### 它如何与心跳和 cron 配合

- **心跳/cron** 决定运行_何时_发生。
- **Lobster** 定义一旦运行开始_发生哪些步骤_。

对于调度的工作流，使用 cron 或心跳触发调用 Lobster 的代理回合。
对于临时工作流，直接调用 Lobster。

### 运营说明（来自代码）

- Lobster 作为**本地子进程**运行（`lobster` CLI）处于工具模式，并返回 **JSON 信封**。
- 如果工具返回 `needs_approval`，你可以使用 `resumeToken` 和 `approve` 标志恢复。
- 该工具是**可选插件**；通过 `tools.alsoAllow: ["lobster"]` 附加启用（推荐）。
- 如果你传递 `lobsterPath`，它必须是**绝对路径**。

有关完整用法和示例，请参阅 [Lobster](/tools/lobster)。

## 主会话 vs 独立会话

心跳和 cron 都可以与主会话交互，但方式不同：

|         | 心跳                        | Cron（主）                | Cron（独立）            |
| ------- | --------------------------- | ------------------------ | ---------------------- |
| 会话    | 主                          | 主（通过系统事件）       | `cron:<jobId>`         |
| 历史记录 | 共享                        | 共享                     | 每次运行都是新的        |
| 上下文  | 完整                        | 完整                     | 无（全新开始）          |
| 模型    | 主会话模型                  | 主会话模型               | 可以覆盖                |
| 输出    | 如果不是 `HEARTBEAT_OK` 则发送 | 心跳提示 + 事件          | 摘要发布到主会话        |

### 何时使用主会话 cron

当你想要以下内容时，使用 `--session main` 和 `--system-event`：

- 提醒/事件出现在主会话上下文中
- 代理在下一次心跳时处理它，并具有完整上下文
- 没有单独的独立运行

```bash
openclaw cron add \
  --name "Check project" \
  --every "4h" \
  --session main \
  --system-event "Time for a project health check" \
  --wake now
```

### 何时使用独立 cron

当你想要以下内容时，使用 `--session isolated`：

- 没有先前上下文的干净环境
- 不同的模型或思考设置
- 直接发送到通道的输出（摘要仍然默认发布到主会话）
- 不会弄乱主会话的历史记录

```bash
openclaw cron add \
  --name "Deep analysis" \
  --cron "0 6 * * 0" \
  --session isolated \
  --message "Weekly codebase analysis..." \
  --model opus \
  --thinking high \
  --deliver
```

## 成本考量

| 机制       | 成本概况                                                     |
| ---------- | ------------------------------------------------------------ |
| 心跳       | 每 N 分钟一个回合；随 HEARTBEAT.md 大小扩展                 |
| Cron（主） | 将事件添加到下一次心跳（没有独立的回合）                     |
| Cron（独立）| 每个任务一个完整的代理回合；可以使用更便宜的模型             |

**提示**：

- 保持 `HEARTBEAT.md` 很小，以最小化 token 开销。
- 将类似的检查批量到心跳中，而不是多个 cron 任务。
- 如果你只需要内部处理，在心跳上使用 `target: "none"`。
- 对于常规任务，使用带有更便宜模型的独立 cron。

## 相关内容

- [心跳](/gateway/heartbeat) - 完整的心跳配置
- [Cron 任务](/automation/cron-jobs) - 完整的 cron CLI 和 API 参考
- [系统](/cli/system) - 系统事件 + 心跳控制
