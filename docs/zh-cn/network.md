---
summary: "OpenClaw 网络中心：网关架构、配对、发现、传输、远程访问和安全网络配置完全指南"
read_when:
  - 你需要理解 OpenClaw 的网络架构和通信模型
  - 你想掌握本地、LAN 和 tailnet 的设备连接方式
  - 你在配置网络访问或调试连接问题
  - 你需要设计安全的网络访问策略
title: "网络配置"
---

# 🌐 OpenClaw 网络中心完全指南

> **学习目标**：完成本章节学习后，你将能够深入理解 OpenClaw 的网络架构，掌握从本地连接到远程访问的完整技术栈，理解配对、发现、传输和安全机制，并能够设计和实施满足各种场景的网络配置方案。

---

## 为什么要学习网络架构

在深入技术细节之前，我们需要先理解**网络层在 OpenClaw 系统中的核心地位**。OpenClaw 不仅仅是一个运行在本地的 AI 助手，它是一个需要连接多个设备、渠道和服务的分布式系统。

### OpenClaw 网络架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                      OpenClaw 网络架构                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌─────────────────────────────────────────────────────────┐    │
│   │                    控制平面 (Gateway)                    │    │
│   │   - WebSocket/HTTP 服务                                 │    │
│   │   - 认证与授权                                           │    │
│   │   - 路由与分发                                           │    │
│   │   - 配置管理                                             │    │
│   └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│              ┌───────────────┼───────────────┐                    │
│              ▼               ▼               ▼                    │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│   │   本地客户端  │  │   远程客户端  │  │    节点      │             │
│   │  - CLI      │  │  - Web UI   │  │  - macOS    │             │
│   │  - TUI     │  │  - WebChat  │  │  - iOS     │             │
│   │  - macOS 应用│ │  - 移动端   │  │  - Android │             │
│   └─────────────┘  └─────────────┘  └─────────────┘             │
│                              │                                   │
│              ┌───────────────┼───────────────┐                    │
│              ▼               ▼               ▼                    │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│   │   渠道服务   │  │   模型服务   │  │   外部服务   │             │
│   │  - Telegram │  │  - Anthropic│  │  - Webhook  │             │
│   │  - WhatsApp│  │  - OpenAI   │  │  - API     │             │
│   │  - Discord │  │  - Google   │  │  - OAuth   │             │
│   └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 网络层的核心职责

| 职责 | 说明 | 关键组件 |
|------|------|----------|
| **连接管理** | 维护客户端连接 | WebSocket、HTTP |
| **认证授权** | 验证访问身份 | Token、API Key |
| **服务发现** | 发现可用服务 | Bonjour/mDNS、DNS |
| **数据传输** | 高效传输数据 | Protocol Buffers、JSON |
| **安全防护** | 保护通信安全 | TLS、认证令牌 |

---

## 认知负荷管理：学习路径设计

```
网络技能金字塔：

                    ┌─────────────────────────┐
                    │   专家级：安全架构     │  零信任网络、端到端加密
                    └─────────────────────────┘
                         ▲
                    ┌─────────────────────────┐
                    │   高级：远程访问       │  Tailscale、SSH 隧道
                    └─────────────────────────┘
                         ▲
                    ┌─────────────────────────┐
                    │   中级：发现与传输     │  Bonjour、传输层选择
                    └─────────────────────────┘
                         ▲
                    ┌─────────────────────────┐
                    │   初级：基础架构       │  Gateway、连接模型
                    └─────────────────────────┘
```

**建议学习路径**：
- 新手：先理解 Gateway 架构和基本连接模型
- 开发者：掌握配对和发现机制
- 运维人员：深入远程访问和安全配置
- 架构师：设计整体网络方案

---

## 第一部分：网络架构基础（⭐ 入门级）

### 学习目标

完成本节学习后，你将能够：
- [ ] 理解 Gateway 的角色和职责
- [ ] 掌握 WebSocket 连接模型
- [ ] 理解不同网络环境的特点
- [ ] 配置基本的网络连接

### 1.1 Gateway 架构详解

**Gateway 的核心角色**：

Gateway 是 OpenClaw 的**控制平面**，是所有连接的中心枢纽：

```
┌─────────────────────────────────────────────────────────────┐
│                    Gateway 核心职责                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   1. 连接中枢                                                │
│      - 维护所有客户端的长连接                                 │
│      - 管理连接状态和心跳                                    │
│      - 处理连接生命周期                                       │
│                                                              │
│   2. 路由中心                                                │
│      - 将请求路由到正确的处理程序                             │
│      - 管理会话和上下文                                      │
│      - 处理消息队列                                          │
│                                                              │
│   3. 安全门禁                                               │
│      - 验证连接身份                                          │
│      - 授权访问权限                                          │
│      - 审计操作日志                                          │
│                                                              │
│   4. 协议转换                                                │
│      - 统一外部协议（WebSocket/HTTP）                        │
│      - 内部 RPC 通信                                         │
│      - 协议适配                                              │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**默认配置**：

```json5
{
  gateway: {
    // 绑定模式：loopback（仅本地）或 0.0.0.0（所有接口）
    bind: "loopback",
    
    // 端口配置
    port: 18789,
    
    // 运行模式
    mode: "local",  // local 或 remote
    
    // 认证配置
    auth: {
      type: "token",  // token、password、none
      token: "${GATEWAY_TOKEN}"
    }
  }
}
```

### 1.2 连接模型

**WebSocket 连接**：

OpenClaw 使用 **WebSocket** 作为主要的双工通信协议：

```
┌─────────────────────────────────────────────────────────────┐
│                  WebSocket 连接生命周期                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   连接建立                                                    │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  Client ──→ HTTP Upgrade ──→ 101 Switching ──→ WS │    │
│   │  发送 Sec-WebSocket-Key                            │    │
│   │  返回 Sec-WebSocket-Accept                        │    │
│   └─────────────────────────────────────────────────────┘    │
│                           │                                  │
│                           ▼                                  │
│   心跳保活                                                    │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  Ping ──→ Pong                                      │    │
│   │  间隔：30 秒                                        │    │
│   │  超时：10 秒                                        │    │
│   └─────────────────────────────────────────────────────┘    │
│                           │                                  │
│                           ▼                                  │
│   数据传输                                                    │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  JSON 格式的 RPC 消息                               │    │
│   │  { "method": "agent.send", "params": {...} }       │    │
│   └─────────────────────────────────────────────────────┘    │
│                           │                                  │
│                           ▼                                  │
│   连接关闭                                                    │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  Close Frame ──→ 状态码 ──→ 清理资源                │    │
│   │  状态码：1000（正常）、1001（离开）、1008（策略）     │    │
│   └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**连接 URI 格式**：

```
# 本地连接
ws://127.0.0.1:18789

# 所有接口
ws://0.0.0.0:18789

# 带认证
ws://127.0.0.1:18789?token=xxx

# WSS（加密）
wss://your-domain.com:18789
```

### 1.3 网络环境与访问模式

**本地访问**：

```
┌─────────────────────────────────────────────────────────┐
│              本地访问模式                                │
├─────────────────────────────────────────────────────────┤
│                                                          │
│   适用场景：                                              │
│   - 开发调试                                              │
│   - 单用户使用                                            │
│   - 不需要外部访问                                        │
│                                                          │
│   配置：                                                  │
│   gateway.bind = "loopback"                              │
│   gateway.port = 18789                                   │
│                                                          │
│   连接地址：                                              │
│   ws://127.0.0.1:18789                                   │
│                                                          │
│   优点：                                                  │
│   - 安全性高（仅本地可访问）                              │
│   - 配置简单                                              │
│   - 性能最佳                                              │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**远程访问模式**：

| 模式 | 适用场景 | 安全性 | 复杂度 |
|------|---------|--------|--------|
| SSH 隧道 | 临时访问、开发 | 中 | 低 |
| Tailscale Serve | 长期远程访问 | 高 | 低 |
| Tailscale Funnel | 公开访问 | 高 | 中 |
| 反向代理 | 企业部署 | 高 | 高 |

---

## 第二部分：配对与身份（⭐⭐ 进阶级）

### 学习目标

完成本节学习后，你将能够：
- [ ] 理解配对机制的原理和类型
- [ ] 掌握 DM 配对和节点配对的过程
- [ ] 配置配对策略和信任模型
- [ ] 管理配对凭据和会话

### 2.1 配对机制概述

**为什么需要配对**：

配对是 OpenClaw 的**身份认证和信任建立**机制：

```
┌─────────────────────────────────────────────────────────────┐
│                  配对的核心目的                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   1. 身份验证                                                │
│      - 确认客户端/节点的身份                                  │
│      - 防止未授权访问                                        │
│                                                              │
│   2. 信任建立                                                │
│      - 建立可信的连接关系                                    │
│      - 限制信任范围                                          │
│                                                              │
│   3. 权限授予                                                │
│      - 定义访问权限                                          │
│      - 控制操作范围                                          │
│                                                              │
│   4. 审计追踪                                                │
│      - 记录连接历史                                          │
│      - 支持安全审计                                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**配对类型**：

| 类型 | 说明 | 典型场景 |
|------|------|----------|
| **DM 配对** | 消息渠道的私聊配对 | Telegram、Discord 私聊 |
| **节点配对** | 设备节点连接配对 | macOS、iOS、Android 节点 |
| **客户端配对** | Web/CLI 客户端配对 | TUI、Web UI 连接 |

### 2.2 DM 配对详解

**配对流程**：

```
┌─────────────────────────────────────────────────────────────┐
│                  DM 配对流程                                  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   步骤 1：陌生人消息                                         │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  陌生人 ──→ /pair ──→ 发送配对请求                   │    │
│   │  Bot ──→ 返回配对码（临时）                          │    │
│   └─────────────────────────────────────────────────────┘    │
│                           │                                  │
│                           ▼                                  │
│   步骤 2：管理员审批                                         │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  管理员审查请求来源                                   │    │
│   │  执行：openclaw pairing approve <channel> <code>    │    │
│   │  或：openclaw pairing reject <channel> <code>       │    │
│   └─────────────────────────────────────────────────────┘    │
│                           │                                  │
│                           ▼                                  │
│   步骤 3：信任建立                                           │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  将发送者加入本地允许列表                             │    │
│   │  设置会话策略（允许/拒绝/配对）                       │    │
│   │  记录配对历史                                        │    │
│   └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**配对策略配置**：

```json5
{
  channels: {
    telegram: {
      dm: {
        // 配对策略：open（开放）、pairing（需配对）、closed（关闭）
        policy: "pairing",
        
        // 允许列表
        allowFrom: ["trusted-user-1", "trusted-user-2"]
      }
    },
    discord: {
      dm: {
        policy: "pairing",
        allowFrom: ["user-id-1", "user-id-2"]
      }
    }
  }
}
```

### 2.3 节点配对详解

**节点类型**：

| 节点类型 | 说明 | 暴露能力 |
|----------|------|----------|
| **macOS** | macOS 应用节点 | 完整系统集成 |
| **iOS** | iOS 应用节点 | 相机、语音 |
| **Android** | Android 应用节点 | 相机、语音、位置 |
| **CLI** | 命令行节点 | 基础工具执行 |

**配对流程**：

```
┌─────────────────────────────────────────────────────────────┐
│                  节点配对流程                                 │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   节点发起                                                  │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  节点 ──→ 发现 Gateway（mDNS/Bonjour）              │    │
│   │  节点 ──→ 显示配对 QR 码/链接                       │    │
│   └─────────────────────────────────────────────────────┘    │
│                           │                                  │
│                           ▼                                  │
│   用户确认                                                  │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  用户扫描 QR 码或点击链接                            │    │
│   │  用户确认配对请求                                    │    │
│   │  Gateway 验证请求（本地信任自动批准）                │    │
│   └─────────────────────────────────────────────────────┘    │
│                           │                                  │
│                           ▼                                  │
│   会话建立                                                  │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  交换公钥（端到端加密）                              │    │
│   │  建立安全通道                                       │    │
│   │  注册节点能力                                       │    │
│   └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**本地信任自动批准**：

```
┌─────────────────────────────────────────────────────────────┐
│              本地信任自动批准规则                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   以下情况自动批准配对：                                      │
│   ✓ 同一主机（127.0.0.1）                                    │
│   ✓ 网关主机的 tailnet 地址                                  │
│   ✓ 同一局域网 IP（需配置）                                   │
│                                                              │
│   以下情况需要手动批准：                                      │
│   ✗ 外部 tailnet 客户端                                      │
│   ✗ 远程网络连接                                             │
│   ✗ 未知来源                                                 │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 第三部分：发现与传输（⭐⭐⭐ 高级）

### 学习目标

完成本节学习后，你将能够：
- [ ] 理解服务发现机制的实现
- [ ] 配置 mDNS/Bonjour 发现
- [ ] 选择和配置传输层
- [ ] 优化网络性能

### 3.1 服务发现机制

**mDNS/Bonjour 发现**：

OpenClaw 使用 **mDNS（多播 DNS）** 进行本地服务发现：

```bash
# 手动发现服务
openclaw devices discover

# 输出示例：
# Found OpenClaw Gateway:
#   Host: openclaw.local (192.168.1.100:18789)
#   Capabilities: gateway, agent, channels
#   Version: v3.0.0
```

**DNS-SD 服务记录**：

```
Service: _openclaw._tcp
Domain: local.
Protocol: TCP
Port: 18789
Properties:
  - version: 3.0.0
  - capabilities: gateway,agent,channels
  - auth: token
```

### 3.2 传输层配置

**传输选项**：

```json5
{
  gateway: {
    // 传输层配置
    transports: {
      // WebSocket 配置
      websocket: {
        enabled: true,
        pingIntervalMs: 30000,
        pingTimeoutMs: 10000,
        maxMessageSize: 104857600,  // 100MB
      },
      
      // HTTP 配置（用于 Webhook）
      http: {
        enabled: true,
        port: 18789,
        cors: {
          enabled: true,
          origins: ["*"]
        }
      }
    }
  }
}
```

**性能调优**：

| 配置项 | 默认值 | 调优建议 |
|--------|--------|----------|
| `pingIntervalMs` | 30000 | 网络不稳定时减小 |
| `maxMessageSize` | 100MB | 大文件传输时增大 |
| `concurrentConnections` | 100 | 高并发时增大 |

---

## 第四部分：远程访问（⭐⭐⭐ 高级）

### 学习目标

完成本节学习后，你将能够：
- [ ] 配置 Tailscale 远程访问
- [ ] 设置 SSH 隧道
- [ ] 实现安全的远程管理
- [ ] 选择适合场景的访问方案

### 4.1 Tailscale 集成

**Serve vs Funnel**：

| 模式 | 访问范围 | 适用场景 | 安全性 |
|------|---------|---------|--------|
| **Serve** | 仅 tailnet 内 | 长期远程访问 | 高（仅内网） |
| **Funnel** | 公网可访问 | 公开服务 | 高（需密码） |

**配置示例**：

```json5
{
  gateway: {
    tailscale: {
      // 模式：off、serve、funnel
      mode: "serve",
      
      // 可选：退出时重置配置
      resetOnExit: true
    },
    
    // 注意：gateway.bind 必须为 "loopback"
    bind: "loopback"
  }
}
```

**Funnel 安全要求**：

```
┌─────────────────────────────────────────────────────────────┐
│              Funnel 模式强制要求                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   ⚠️  Funnel 模式强制要求以下配置：                          │
│                                                              │
│   1. 认证模式必须为 password                                 │
│      gateway.auth.type = "password"                         │
│                                                              │
│   2. 或明确禁用 Tailscale 访问                               │
│      gateway.auth.allowTailscale = false                    │
│                                                              │
│   原因：公网暴露需要强认证                                    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 SSH 隧道

**本地端口转发**：

```bash
# 创建 SSH 隧道
ssh -L 18789:127.0.0.1:18789 user@gateway-host

# 隧道保持活跃（每 60 秒发送心跳）
ssh -o ServerAliveInterval=60 -L 18789:127.0.0.1:18789 user@gateway-host
```

**远程端口转发（反向隧道）**：

```bash
# 在网关主机上执行
ssh -R 18789:127.0.0.1:18789 user@remote-host

# 或使用 autossh 自动重连
autossh -M 0 -o "ServerAliveInterval 60" -R 18789:127.0.0.1:18789 user@remote-host
```

---

## 第五部分：安全网络配置（⭐⭐⭐⭐）

### 学习目标

完成本节学习后，你将能够：
- [ ] 设计零信任网络架构
- [ ] 配置端到端加密
- [ ] 实施网络隔离策略
- [ ] 审计网络访问

### 5.1 安全架构设计

**分层安全模型**：

```
┌─────────────────────────────────────────────────────────────┐
│                  分层安全架构                                 │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  应用层：认证、授权、审计                             │    │
│   │  - Token 验证                                       │    │
│   │  - 权限控制                                         │    │
│   │  - 操作日志                                         │    │
│   └─────────────────────────────────────────────────────┘    │
│                         │                                   │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  传输层：加密、认证、完整性                          │    │
│   │  - TLS 1.3                                         │    │
│   │  - 证书验证                                         │    │
│   │  - mTLS（可选）                                     │    │
│   └─────────────────────────────────────────────────────┘    │
│                         │                                   │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  网络层：隔离、过滤、防火墙                          │    │
│   │  - 端口过滤                                         │    │
│   │  - IP 白名单                                        │    │
│   │  - VPN/Tailscale                                   │    │
│   └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 认证与授权

**Token 认证**：

```json5
{
  gateway: {
    auth: {
      type: "token",
      token: "${GATEWAY_TOKEN}",
      
      // Token 过期时间（可选）
      expiresIn: "24h",
      
      // 刷新 Token 策略
      refresh: {
        enabled: true,
        maxUses: 1000
      }
    }
  }
}
```

**密码认证**：

```json5
{
  gateway: {
    auth: {
      type: "password",
      
      // 密码哈希（bcrypt）
      passwordHash: "$2b$10$...",
      
      // 密码策略
      policy: {
        minLength: 12,
        requireUppercase: true,
        requireLowercase: true,
        requireNumbers: true,
        requireSymbols: true,
        maxAge: "90d"
      }
    }
  }
}
```

---

## 第六部分：故障排查速查

### 快速诊断命令

```bash
# 检查 Gateway 状态
openclaw status

# 测试本地连接
curl ws://127.0.0.1:18789

# 检查端口占用
ss -ltnp | grep 18789

# 查看网络日志
openclaw logs --follow | grep -i "connect\|disconnect\|auth"

# 检查配对状态
openclaw pairing list

# 发现可用设备
openclaw devices discover
```

### 常见问题与解决方案

**问题一：Gateway 不可达**

**排查步骤**：

```bash
# 1. 检查进程
ps aux | grep openclaw

# 2. 检查端口
ss -ltnp | grep 18789

# 3. 检查防火墙
sudo ufw status

# 4. 测试本地连接
curl http://127.0.0.1:18789/health
```

**问题二：配对失败**

**排查步骤**：

```bash
# 1. 检查配对模式
openclaw config get channels.telegram.dm.policy

# 2. 查看配对日志
openclaw logs --follow | grep pairing

# 3. 列出已配对设备
openclaw pairing list

# 4. 手动审批配对
openclaw pairing approve telegram <code>
```

**问题三：Tailscale 访问失败**

**排查步骤**：

```bash
# 1. 检查 Tailscale 状态
tailscale status

# 2. 检查 Serve 配置
tailscale serve status

# 3. 检查网关配置
openclaw config get gateway.tailscale

# 4. 查看 Tailscale 日志
tailscale logs
```

---

## 练习与自检

### 基础技能自检

- [ ] 理解 Gateway 的角色和职责
- [ ] 能够配置基本的网络连接
- [ ] 理解不同网络环境的特点
- [ ] 掌握基本的连接测试方法

### 进阶技能自检

- [ ] 理解配对机制的原理
- [ ] 能够配置 DM 和节点配对
- [ ] 掌握服务发现配置
- [ ] 能够选择传输层配置

### 专家技能自检

- [ ] 能够设计远程访问方案
- [ ] 理解 Tailscale 集成
- [ ] 掌握网络安全架构设计
- [ ] 能够实施安全审计

---

## 参考资料

### 核心文档

- [网关配置](/zh-CN/gateway/configuration) - Gateway 详细配置
- [安全指南](/zh-CN/gateway/security) - 安全最佳实践
- [故障排除](/zh-CN/gateway/troubleshooting) - 问题解决方案

### 相关命令速查

```bash
# 状态与诊断
openclaw status           # 网关状态
openclaw devices discover # 发现设备
openclaw pairing list    # 配对列表

# 连接管理
openclaw gateway start   # 启动网关
openclaw gateway stop    # 停止网关
openclaw gateway restart # 重启网关

# 日志与调试
openclaw logs --follow   # 尾随日志
openclaw doctor          # 完整诊断
```

### 扩展阅读

- [WebSocket 协议](https://datatracker.ietf.org/doc/html/rfc6455)
- [mDNS/DNS-SD](https://datatracker.ietf.org/doc/html/rfc6762)
- [Tailscale 文档](https://tailscale.com/docs/)
